<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">

    <!-- jQuery, Bootstrap, DataTables, SweetAlert, Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <style>
        .loading {
            display: none;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .select2-container .select2-selection--single {
            height: 37px !important;
            padding: 5px 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .select2-container .select2-selection__rendered {
            line-height: 28px !important;
        }
        .select2-container .select2-selection__arrow {
            height: 36px !important;
        }
        .different-treasury {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body class="container py-4" style="background-color: #d7e2ff6e;min-width: 100%;">
    <div class="card p-4">
        <h5>UMAS Employee Details</h5><hr>
        <div class="row g-3">
            <div class="col-md-5">
                <label for="treasuryName" class="form-label">Treasury Name:</label>
                <select id="treasuryName" class="form-control select2" required></select>
            </div>
            <div class="col-md-5">
                <label for="role" class="form-label">Role:</label>
                <select id="role" class="form-control select2">
                    <option value="">All Roles</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary" onclick="searchEmployeeData()">View</button>
            </div>
        </div>
        
        <div class="loading mt-3"><img src="https://itcelldto.github.io/try/Spinner-3.gif">  Loading.Please wait...</div>
        <br>
        
        <div class="card p-4">
            <h5 id="resultHeading" class="" style="color: #5f87c5;">Employee Details <span id="employeeCount" style="font-size: 14px; color: #ff0000;"></span></h5>
            <hr> 
            <table id="resultTable" class="table table-striped table-bordered dataTable">
                <thead>
                    <tr>
                        <th>From Treasury(Lean office)</th>
                        <th>Employee Name</th>
                        <th>PEN</th>
                        <th>Designation</th>
                        <th>Role</th>
                        <th>eOffice Sec</th>
                        <th>Joined Date</th>
                        <th>Retirement Date</th>
                        <th>Phone Number</th>
                        <th>Email-ID</th>
                        <th>IP</th>
                    </tr>
                </thead>
                <tbody style="font-size: 12px;"></tbody>
            </table>
        </div>
    </div>
    	  
    <script>
    // Cache for eOffice Sec data
    let eOfficeSecMap = {};
    // Cache for From Treasury and Lean Period data
    let fromTreasuryMap = {};
    let leanStartMap = {};
    let leanEndMap = {};
    
    $(document).ready(function() {
        $('.select2').select2();
        fetchTreasuryNames();
        fetchRoles();
    });

    function fetchTreasuryNames() {
        let sheetId = "1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM";
        let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
        let range = "umas-onboard!A2:A"; // Fetch Treasury Name column
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let treasuryDropdown = $('#treasuryName');
                treasuryDropdown.empty();
                treasuryDropdown.append('<option value="">Select Treasury Name</option>');
                let uniqueNames = [...new Set((data.values || []).flat())];
                uniqueNames.forEach(name => {
                    treasuryDropdown.append(`<option value="${name}">${name}</option>`);
                });
            })
            .catch(error => console.error("Error fetching Treasury Names:", error));
    }

    function fetchRoles() {
        let sheetId = "1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM";
        let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
        let range = "umas-onboard!E2:E"; // Fetch Role column
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let roleDropdown = $('#role');
                roleDropdown.find('option:not(:first)').remove();
                let uniqueRoles = [...new Set((data.values || []).flat())];
                uniqueRoles.forEach(role => {
                    roleDropdown.append(`<option value="${role}">${role}</option>`);
                });
            })
            .catch(error => console.error("Error fetching Roles:", error));
    }

    async function fetchAllEOfficeSecData() {
        try {
            let sheetId = "1bGd83-iK7XHBygGivClAlqpWwTi4Ha2E6dmCj_PF-Rg";
            let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
            let range = "Transfer_EMD_Try_View!B2:E"; // PEN is column B, eOffice Sec is column E
            let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

            const response = await fetch(url);
            const data = await response.json();
            const rows = data.values || [];
            
            // Create a mapping of PEN to eOffice Sec
            eOfficeSecMap = {};
            rows.forEach(row => {
                if (row[0] && row[3]) { // Ensure both PEN and eOffice Sec exist
                    eOfficeSecMap[row[0]] = row[3];
                }
            });
            
            return true;
        } catch (error) {
            console.error("Error fetching eOffice Sec data:", error);
            return false;
        }
    }

    async function fetchFromTreasuryAndLeanData() {
        try {
            let sheetId = "1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM";
            let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
            let range = "umas-onboard!B2:O"; // PEN is column B, From Treasury is M, Lean Start is N, Lean End is O
            let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

            const response = await fetch(url);
            const data = await response.json();
            const rows = data.values || [];
            
            // Create mappings for From Treasury and Lean Period
            fromTreasuryMap = {};
            leanStartMap = {};
            leanEndMap = {};
            
            rows.forEach(row => {
                if (row[0]) { // PEN exists
                    if (row[11]) fromTreasuryMap[row[0]] = row[11]; // Column M (index 11)
                    if (row[12]) leanStartMap[row[0]] = row[12]; // Column N (index 12)
                    if (row[13]) leanEndMap[row[0]] = row[13]; // Column O (index 13)
                }
            });
            
            return true;
        } catch (error) {
            console.error("Error fetching From Treasury and Lean Period data:", error);
            return false;
        }
    }

    async function searchEmployeeData() {
        let treasuryName = $('#treasuryName').val();
        let role = $('#role').val();

        if (!treasuryName) {
            Swal.fire('Error', 'Please select Treasury Name', 'error');
            return;
        }

        $('.loading').show();

        try {
            // First fetch all eOffice Sec data and From Treasury + Lean Period data
            const eOfficeDataLoaded = await fetchAllEOfficeSecData();
            const fromTreasuryDataLoaded = await fetchFromTreasuryAndLeanData();
            
            if (!eOfficeDataLoaded) {
                Swal.fire('Warning', 'Could not load eOffice Sec data. Showing employee data without eOffice Sec.', 'warning');
            }
            if (!fromTreasuryDataLoaded) {
                Swal.fire('Warning', 'Could not load From Treasury data. Showing employee data without From Treasury information.', 'warning');
            }

            // Then fetch employee data
            let sheetId = "1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM";
            let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
            let range = "umas-onboard!A2:J";
            let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

            const response = await fetch(url);
            const data = await response.json();
            let rows = data.values || [];
            
            let filteredRows = rows.filter(row => {
                let rowTreasury = row[0]; // Column A (Treasury Name)
                let rowRole = row[4]; // Column E (Role)
                
                return rowTreasury === treasuryName && 
                       (role === "" || rowRole === role);
            });

            // Process rows to add eOffice Sec and From Treasury with Lean Period
            const processedRows = filteredRows.map(row => {
                const pen = row[1]; // Column B (PEN)
                const eOfficeSec = eOfficeSecMap[pen] || '';
                const fromTreasury = fromTreasuryMap[pen] || '';
                const leanStart = leanStartMap[pen] || '';
                const leanEnd = leanEndMap[pen] || '';
                
                // Format the From Treasury with Lean Period
                let fromTreasuryDisplay = fromTreasury;
                if (leanStart || leanEnd) {
                    fromTreasuryDisplay += ` (${leanStart} - ${leanEnd})`;
                }
                
                return [
                    fromTreasuryDisplay, // From Treasury with Lean Period (will be first column)
                    row[2],  // Employee Name
                    row[1],  // PEN
                    row[3],  // Designation
                    row[4],  // Role
                    eOfficeSec, // eOffice Sec
                    row[6],  // Joined Date
                    row[7],  // Retirement Date
                    row[8],  // Phone Number
                    row[9],  // Email-ID
                    row[10]   // IP
                ];
            });

            displayEmployeeResults(processedRows, treasuryName);
            $('.loading').hide();
        } catch (error) {
            console.error("Error fetching employee data: ", error);
            $('.loading').hide();
            Swal.fire('Error', 'Failed to fetch employee data', 'error');
        }
    }

    function displayEmployeeResults(data, selectedTreasury) {
        if ($.fn.DataTable.isDataTable('#resultTable')) {
            $('#resultTable').DataTable().destroy();
        }
        
        let tableBody = $("#resultTable tbody");
        tableBody.empty();

        data.forEach(row => {
            // Extract just the treasury name (before the bracket) for comparison
            const fromTreasuryOnly = row[0].split(' (')[0];
            const isDifferentTreasury = fromTreasuryOnly && fromTreasuryOnly !== selectedTreasury;
            const treasuryClass = isDifferentTreasury ? 'different-treasury' : '';
            
            tableBody.append(`<tr>
                <td class="${treasuryClass}">${row[0] || ''}</td> <!-- From Treasury with Lean Period -->
                <td>${row[1] || ''}</td> <!-- Employee Name -->
                <td>${row[2] || ''}</td> <!-- PEN -->
                <td>${row[3] || ''}</td> <!-- Designation -->
                <td>${row[4] || ''}</td> <!-- Role -->
                <td>${row[5] || ''}</td> <!-- eOffice Sec -->
                <td>${row[6] || ''}</td> <!-- Joined Date -->
                <td>${row[7] || ''}</td> <!-- Retirement Date -->
                <td>${row[8] || ''}</td> <!-- Phone Number -->
                <td>${row[9] || ''}</td> <!-- Email-ID -->
                <td>${row[10] || ''}</td> <!-- IP -->
            </tr>`);
        });

        $('#employeeCount').text(`(${data.length} employees found)`);
        
        $('#resultTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            searching: true,
            ordering: true,
            destroy: true,
            scrollX: true
        });

        if (data.length === 0) {
            Swal.fire('No Records Found', 'No matching records found for the selected criteria.', 'info');
        }
    }
    </script>
</body>
</html>
