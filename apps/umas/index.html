<!DOCTYPE html>
<html>
<head>
    <title>Treasury Option Form</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #d7e2ff6e;
            padding: 20px;
        }
        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin: 10px 40px 30px 40px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
     
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        select {
            width: 100%;
            height: 30px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 15px;
        }
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .col {
            flex: 1;
        }
        .form-control, .form-select, .select2-selection {
            height: calc(1.5em + 0.75rem + 2px) !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 0.875rem !important;
        }
        .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        .btn-group {
            width: 100%;
        }
        .btn-group .btn {
            width: 50%;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 20px;
        }
        .select2-container--default .select2-selection--single {
            height: 42px;
            padding: 5px;
            border: 1px solid #ddd;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 35px;
        }
        .section-header {
            background-color: #f0f7ff;
            padding: 10px 15px;
            margin: 25px 0 15px 0;
            border-left: 4px solid #4285f4;
            font-weight: bold;
            color: #2c3e50;
        }
        .hidden-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h3>UMAS Data Change Form</h3>
        
        <form id="treasuryForm">
            <div class="form-group">
                <label for="treasury">Treasury*</label>
                <select id="treasury" name="treasury" class="form-control select2-dropdown" required></select>
            </div>
            
            <div class="form-group">
                <label for="optionFor">Option For*</label>
                <select id="optionFor" name="optionFor" class="form-control select2-dropdown" required>
                    <option value="">Select Option</option>
                    <option value="User Activation">User Activation</option>
                    <option value="Charge Arrangement" selected>Charge Arrangement</option>
                    <option value="Role Change">Role Change</option>
                    <option value="Designation Change">Designation Change</option>
                </select>
            </div>
            
            <div class="section-header">From Employee Details</div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="fromPEN">From PEN</label>
                        <input type="text" class="form-control" id="fromPEN" name="fromPEN" placeholder="Employee PEN or Give '0' for Vacant ">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fromName">From Name*</label>
                        <input type="text" class="form-control" id="fromName" name="fromName" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="fromDesignation">From Designation</label>
                        <select id="fromDesignation" name="fromDesignation" class="form-control select2-dropdown"></select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fromRole">From Role</label>
                        <select id="fromRole" name="fromRole" class="form-control select2-dropdown"></select>
                    </div>
                </div>
            </div>
            
            <div class="section-header to-employee-section">To Employee Details</div>
            
            <div class="row to-employee-section">
                <div class="col">
                    <div class="form-group">
                        <label for="toPEN">To PEN</label>
                        <input type="text" class="form-control" id="toPEN" name="toPEN">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toName">To Name*</label>
                        <input type="text" class="form-control" id="toName" name="toName" required>
                    </div>
                </div>
            </div>
            
            <div class="row to-employee-section">
                <div class="col">
                    <div class="form-group">
                        <label for="toDesignation">To Designation</label>
                        <select id="toDesignation" name="toDesignation" class="form-control select2-dropdown"></select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toRole">To Role</label>
                        <select id="toRole" name="toRole" class="form-control select2-dropdown"></select>
                    </div>
                </div>
            </div>
            
            <div class="section-header date-range-section">Date Range</div>
            
            <div class="row date-range-section">
                <div class="col">
                    <div class="form-group">
                        <label for="fromDate">From Date*</label>
                        <input type="text" id="fromDate" name="fromDate" class="form-control flatpickr-input" placeholder="DD/MM/YYYY" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toDate">To Date*</label>
                        <input type="text" id="toDate" name="toDate" class="form-control flatpickr-input" placeholder="DD/MM/YYYY" required>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="reset" class="btn btn-secondary">Reset</button>
              
     <a href="#" class="btn btn-light" onclick="openPopup()">PDF</a>    
            </div>
        </form>
        <div id="requestIdLabel" style="font-weight: bold; color: red; text-align: center; margin-top: 15px;"></div>
    </div>
       <script>
    function openPopup() {
    const url = "https://script.google.com/macros/s/AKfycbzywjcUltvzofjDglUovicJfcWWN1oe0jFZCRwhCgA/dev";
    const windowFeatures = "width=600,height=400,resizable=yes,scrollbars=yes";
    const popup = window.open(url, "PopupWindow", windowFeatures);

    if (!popup || popup.closed || typeof popup.closed === "undefined") {
        // Pop-up blocked, open in the same tab
        window.location.href = url;
    }
}
</script>
    <script>
        // Configuration
        const CONFIG = {
            mainSpreadsheetId: '1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM',
            employeeSpreadsheetId: '1pOhA7N0HufnqmwD7KBCW8xhDKCh-gxZ-tOeZ2-4qq7k',
            apiKey: 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4'
        };

        // Initialize date pickers with DD/MM/YYYY format
        const fromDatePicker = flatpickr("#fromDate", {
            dateFormat: "d/m/Y",
            allowInput: true
        });
        
        const toDatePicker = flatpickr("#toDate", {
            dateFormat: "d/m/Y",
            allowInput: true
        });

        // Initialize Select2 dropdowns
        $(document).ready(function() {
            $('.select2-dropdown').select2({
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select an option';
                }
            });
            
            // Load dropdown data when page loads
            loadDropdownData();
            
            // Setup PEN input event listeners
            setupPENAutofill();
            
            // Handle Option For change
            $('#optionFor').on('change', handleOptionForChange);
            
            // Set initial state
            handleOptionForChange();
            
            // Reset form handler
            $('button[type="reset"]').on('click', function() {
                setTimeout(function() {
                    handleOptionForChange();
                    $('.select2-dropdown').val(null).trigger('change');
                    document.getElementById('requestIdLabel').textContent = ''; // Clear request ID on reset
                }, 0);
            });
        });

        function handleOptionForChange() {
            const optionFor = $('#optionFor').val();
            const today = new Date();
            const todayFormatted = formatDate(today);
            
            if (optionFor === "User Activation") {
                // Set dates to today
                fromDatePicker.setDate(today, true);
                toDatePicker.setDate(today, true);
                
                // Copy from employee details to to employee details
                $('#toPEN').val($('#fromPEN').val());
                $('#toName').val($('#fromName').val());
                $('#toDesignation').val($('#fromDesignation').val()).trigger('change');
                $('#toRole').val($('#fromRole').val()).trigger('change');
                
                // Hide to employee section and date range section
                $('.to-employee-section, .date-range-section').addClass('hidden-section');
            } else {
                // Show to employee section and date range section
                $('.to-employee-section, .date-range-section').removeClass('hidden-section');
                
                // Reset to employee details
                $('#toPEN').val('');
                $('#toName').val('');
                $('#toDesignation').val(null).trigger('change');
                $('#toRole').val(null).trigger('change');
                
                // Reset dates
                fromDatePicker.clear();
                toDatePicker.clear();
            }
        }

        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Generate Request ID in YYMMDDHHMMSS format
        function generateRequestId() {
            const now = new Date();
            return [
                now.getFullYear().toString().slice(-2),
                (now.getMonth() + 1).toString().padStart(2, '0'),
                now.getDate().toString().padStart(2, '0'),
                now.getHours().toString().padStart(2, '0'),
                now.getMinutes().toString().padStart(2, '0'),
                now.getSeconds().toString().padStart(2, '0')
            ].join('');
        }

        // Format timestamp as DD/MM/YYYY HH:MM:SS
        function formatTimestamp(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        // Fetch data from Google Sheets
        async function fetchSheetData(spreadsheetId, range, sheetName) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!${range}?key=${CONFIG.apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values || [];
        }

        // Load dropdown data from Sheets
        async function loadDropdownData() {
            try {
                // Load data from Settings sheet
                const [treasuryCodes, designations, roles, optionsFor] = await Promise.all([
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'A2:A', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'B2:B', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'C2:C', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'D2:D', 'settings')
                ]);
                
                // Populate dropdowns
                populateDropdown('treasury', treasuryCodes.flat());
                populateDropdown('fromDesignation', designations.flat());
                populateDropdown('toDesignation', designations.flat());
                populateDropdown('fromRole', roles.flat());
                populateDropdown('toRole', roles.flat());
                populateDropdown('optionFor', optionsFor.flat());
                
                // Set default value for Option For
                $('#optionFor').val('Charge Arrangement').trigger('change');
                
                return true;
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                Swal.fire('Error', 'Failed to load dropdown data', 'error');
                return false;
            }
        }

        function populateDropdown(id, items) {
            const $dropdown = $(`#${id}`);
            $dropdown.empty().append('<option value=""></option>');
            
            if (items && items.length) {
                const uniqueItems = [...new Set(items)]; // Remove duplicates
                uniqueItems.forEach(item => {
                    if (item) $dropdown.append($('<option>').val(item).text(item));
                });
            }
            $dropdown.trigger('change');
        }

        // Setup PEN number autofill functionality
        function setupPENAutofill() {
            // From PEN autofill
            $('#fromPEN').on('change', async function() {
                const pen = $(this).val();
                if (pen) {
                    await autofillEmployeeDetails(pen, 'from');
                    // If Option For is "User Activation", copy to to employee details
                    if ($('#optionFor').val() === "User Activation") {
                        $('#toPEN').val(pen);
                        $('#toName').val($('#fromName').val());
                        $('#toDesignation').val($('#fromDesignation').val()).trigger('change');
                        $('#toRole').val($('#fromRole').val()).trigger('change');
                    }
                }
            });
            
            // To PEN autofill (only when not User Activation)
            $('#toPEN').on('change', async function() {
                if ($('#optionFor').val() !== "User Activation") {
                    const pen = $(this).val();
                    if (pen) {
                        await autofillEmployeeDetails(pen, 'to');
                    }
                }
            });
        }

        // Autofill employee details based on PEN
        async function autofillEmployeeDetails(pen, prefix) {
            try {
                // Fetch all employee data
                const employeeData = await fetchSheetData(CONFIG.employeeSpreadsheetId, 'A2:E', 'employee');
                
                // Find employee with matching PEN
                const employee = employeeData.find(row => row[2] === pen);
                
                if (employee) {
                    // Update form fields
                    $(`#${prefix}Name`).val(employee[1]);
                    $(`#${prefix}Designation`).val(employee[3]).trigger('change');
                    $(`#${prefix}Role`).val(employee[4]).trigger('change');
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Employee Not Found',
                        text: `No employee found with PEN: ${pen}`,
                        timer: 2000
                    });
                }
            } catch (error) {
                console.error('Error fetching employee data:', error);
                Swal.fire('Error', 'Failed to fetch employee details', 'error');
            }
        }

        document.getElementById('treasuryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
            
            // Get form data
            const formData = new FormData(this);
            const formObject = {};
            formData.forEach((value, key) => {
                formObject[key] = value;
            });
            
            // Generate request ID, formatted timestamp, and set status
            formObject.requestId = generateRequestId();
            formObject.timestamp = formatTimestamp(new Date());
            formObject.status = "Pending"; // Always set status to "Pending"
            
            // For User Activation, ensure to employee details match from employee details
            if (formObject.optionFor === "User Activation") {
                formObject.toPEN = formObject.fromPEN;
                formObject.toName = formObject.fromName;
                formObject.toDesignation = formObject.fromDesignation;
                formObject.toRole = formObject.fromRole;
            }
            
            // Create URL with parameters to use GET instead of POST
            const url = new URL('https://script.google.com/macros/s/AKfycbwXvCX8W0iMUxR5mvLXW5TbaoRvb0gdOYpJZrPFkVzdgtAByIH6YQNXyqwtF4QtJzS63A/exec');
            Object.keys(formObject).forEach(key => {
                url.searchParams.append(key, formObject[key]);
            });
            
            // Send data to Google Apps Script using GET
            fetch(url, {
                method: 'GET',
                redirect: 'follow'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = text ? JSON.parse(text) : {};
                    if (data.result === 'success') {
                        // Update the request ID label
                        document.getElementById('requestIdLabel').textContent = `Request ID: ${formObject.requestId}`;
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Form submitted successfully!',
                            footer: `Request ID: ${formObject.requestId}<br>Timestamp: ${formObject.timestamp}`
                        });
                        document.getElementById('treasuryForm').reset();
                        $('.select2-dropdown').val(null).trigger('change');
                        handleOptionForChange(); // Reset visibility
                    } else {
                        throw new Error(data.message || 'Failed to submit form');
                    }
                } catch {
                    // Update the request ID label
                    document.getElementById('requestIdLabel').textContent = `Request ID: ${formObject.requestId}`;
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Form submitted successfully!',
                        footer: `Request ID: ${formObject.requestId}<br>Timestamp: ${formObject.timestamp}`
                    });
                    document.getElementById('treasuryForm').reset();
                    $('.select2-dropdown').val(null).trigger('change');
                    handleOptionForChange(); // Reset visibility
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                });
                console.error('Error:', error);
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            });
        });
    </script>
</body>
</html>
