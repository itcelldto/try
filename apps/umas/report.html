<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMAS User Data Change Report | District Treasury Trivandrum</title>
    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    
    <!-- jQuery, Bootstrap, DataTables, SweetAlert, Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    
    <!-- jQuery UI Datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        .loading {
            display: none;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .select2-container .select2-selection--single {
            height: 37px !important;
            padding: 5px 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .select2-container .select2-selection__rendered {
            line-height: 28px !important;
        }
        .select2-container .select2-selection__arrow {
            height: 36px !important;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pdf-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .pdf-btn:hover {
            background-color: #c82333;
        }
        body {
            background-color: #d7e2ff6e;
            min-width: 100%;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0px 0 30px rgba(1, 41, 112, 0.1);
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #f8fbff;
        }
        .small-font {
            font-size: 11px;
        }
    </style>
</head>
<body class="container py-4">
    <div class="card p-4">
        <h5 style="color: #5f87c5;">UMAS User Data Change Report - District Treasury Trivandrum</h5>
        <hr>
        <div class="row g-3">
            <div class="col-md-3">
                <label for="fromDate" class="form-label">From Date:</label>
                <input type="text" id="fromDate" class="form-control" placeholder="DD/MM/YYYY" required>
            </div>
            <div class="col-md-3">
                <label for="toDate" class="form-label">To Date:</label>
                <input type="text" id="toDate" class="form-control" placeholder="DD/MM/YYYY" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary" onclick="searchData()">View</button>
            </div>
        </div>
        <div class="loading mt-3">
            <img src="https://itcelldto.github.io/try/Spinner-3.gif" alt="Loading..."> Loading. Please wait...
        </div>
        <br>

        <div class="card p-4">
            <div class="result-header">
                <h5 id="resultHeading" style="color: #5f87c5;">Report Details <span id="reportCount" style="font-size: 14px; color: #ff0000;"></span></h5>
                <button id="pdfButton" class="pdf-btn" style="display: none;">Export to PDF</button>
            </div>
            <hr>
            <div class="table-responsive">
                <table id="resultTable" class="table table-striped table-bordered small-font" style="width:100%">
                    <thead>
                        <tr>
                            <th>S.No</th>
                            <th>Treasury</th>
                            <th>Option For</th>
                            <th>From Name</th>
                            <th>From PEN</th>
                            <th>From Designation</th>
                            <th>From Role</th>
                            <th>To Name</th>
                            <th>To PEN</th>
                            <th>To Designation</th>
                            <th>To Role</th>
                            <th>From Date</th>
                            <th>To Date</th>
                        </tr>
                    </thead>
                    <tbody style="font-size: 11px;"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="13" class="text-center fw-bold" id="totalRecords">Total Records: 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let currentData = []; // Store current table data for PDF export
        
        $(document).ready(function () {
            // Initialize jQuery UI Datepicker
            $("#fromDate, #toDate").datepicker({
                dateFormat: "dd/mm/yy",
                changeMonth: true,
                changeYear: true
            });
            
            // Set default dates
            setDefaultDates();
            
            // Initialize PDF button click handler
            $('#pdfButton').click(generatePDF);
        });

        function setDefaultDates() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            // Format today as DD/MM/YYYY
            const toDateStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            
            // Format last month as DD/MM/YYYY
            const fromDateStr = `${String(lastMonth.getDate()).padStart(2, '0')}/${String(lastMonth.getMonth() + 1).padStart(2, '0')}/${lastMonth.getFullYear()}`;
            
            $('#toDate').val(toDateStr);
            $('#fromDate').val(fromDateStr);
        }
        
        function searchData() {
            let fromDateInput = $('#fromDate').val();
            let toDateInput = $('#toDate').val();

            if (!fromDateInput || !toDateInput) {
                Swal.fire('Error', 'Please enter both From Date and To Date', 'error');
                return;
            }

            let fromDate = parseDate(fromDateInput);
            let toDate = parseDate(toDateInput);

            $('.loading').show();

            let sheetId = "1pOhA7N0HufnqmwD7KBCW8xhDKCh-gxZ-tOeZ2-4qq7k";
            let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
            let range = "DB!A:L";
            let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    let rows = data.values || [];
                    rows.shift(); // Remove header row

                    let filteredRows = rows.filter(row => {
                        if (row.length < 12) return false; // Ensure row has all 12 columns
                        let rowFromDate = parseDate(row[10]); // Column K (0-indexed) - From Date
                        let rowToDate = parseDate(row[11]); // Column L (0-indexed) - To Date
                        
                        // Check if date is within range
                        return rowFromDate >= fromDate && rowToDate <= toDate;
                    });
                    
                    currentData = filteredRows; // Store data for PDF export
                    displayResults(filteredRows);
                    $('.loading').hide();
                    
                    // Show PDF button if there are results
                    if (filteredRows.length > 0) {
                        $('#pdfButton').show();
                    } else {
                        $('#pdfButton').hide();
                    }
                    
                    // Update result heading
                    updateResultHeading(filteredRows.length);
                })
                .catch(error => {
                    console.error("Error fetching data: ", error);
                    $('.loading').hide();
                    $('#pdfButton').hide();
                    Swal.fire('Error', 'Failed to fetch data from Google Sheets', 'error');
                });
        }
        
        function updateResultHeading(totalRecords) {
            if (totalRecords > 0) {
                $("#resultHeading").html(`UMAS User Data Change Report - District Treasury Trivandrum <span id="reportCount" style="font-size: 14px; color: #ff0000;">(${totalRecords} records found)</span>`);
                $('#totalRecords').text(`Total Records: ${totalRecords}`);
            } else {
                $("#resultHeading").html("UMAS User Data Change Report - District Treasury Trivandrum");
                $('#totalRecords').text("Total Records: 0");
            }
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            let parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]); // yyyy, mm-1, dd
            }
            return new Date(0);
        }
        
        function displayResults(data) {
            if ($.fn.DataTable.isDataTable('#resultTable')) {
                $('#resultTable').DataTable().destroy();
            }
            
            let tableBody = $("#resultTable tbody");
            tableBody.empty();
            
            data.forEach((row, index) => {
                tableBody.append(`<tr>
                    <td>${index + 1}</td>
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>${row[4] || ''}</td>
                    <td>${row[5] || ''}</td>
                    <td>${row[6] || ''}</td>
                    <td>${row[7] || ''}</td>
                    <td>${row[8] || ''}</td>
                    <td>${row[9] || ''}</td>
                    <td>${row[10] || ''}</td>
                    <td>${row[11] || ''}</td>
                </tr>`);
            });
            
            $('#resultTable').DataTable({
                paging: true,
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                searching: true,
                ordering: true,
                destroy: true,
                responsive: true,
                scrollX: true,
                language: {
                    search: "Search:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });

            if (data.length === 0) {
                Swal.fire('No Records Found', 'No matching records found for the selected date range.', 'info');
            }
        }
        
function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
    });
    
    const today = new Date();
    const dateStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
    const printedDate = `Printed on: ${dateStr}`;
    
    // Prepare PDF data
    const pdfData = currentData.map((row, index) => {
        return [
            index + 1,
            row[0] || '',
            row[1] || '',
            row[2] || '',
            row[3] || '',
            row[4] || '',
            row[5] || '',
            row[6] || '',
            row[7] || '',
            row[8] || '',
            row[9] || '',
            row[10] || '',
            row[11] || ''
        ];
    });
    
    // Main heading - Only on first page
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text('UMAS User Data Change Report - District Treasury Trivandrum', 148.5, 15, { align: 'center' });
    
    // Printed date - Only on first page
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(printedDate, 280, 15, { align: 'right' });
    
    // Date range - Only on first page
    doc.setFontSize(11);
    doc.text(`Date Range: ${$('#fromDate').val()} to ${$('#toDate').val()}`, 14, 25);
    doc.text(`Total Records: ${currentData.length}`, 250, 25, { align: 'right' });
    
    // Add a line separator - Only on first page
    doc.setLineWidth(0.5);
    doc.line(14, 30, 277, 30);
    
    // Calculate available width for table (297mm - 20mm margins)
    const pageWidth = 297; // A4 landscape width in mm
    const leftMargin = 10;
    const rightMargin = 10;
    const availableWidth = pageWidth - leftMargin - rightMargin;
    
    // Create table with adjusted settings
    doc.autoTable({
        startY: 35,
        head: [
            ['S.No', 'Treasury', 'Option For', 'From Name', 'From PEN', 'From Designation', 'From Role', 
             'To Name', 'To PEN', 'To Designation', 'To Role', 'From Date', 'To Date']
        ],
        body: pdfData,
        theme: 'grid',
        margin: { top: 35, left: leftMargin, right: rightMargin, bottom: 40 },
        headStyles: {
            fillColor: [200, 200, 200],
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            fontSize: 7,
            cellPadding: 1
        },
        styles: {
            cellPadding: 1,
            fontSize: 6,
            textColor: [0, 0, 0],
            lineColor: [0, 0, 0],
            lineWidth: 0.1,
            overflow: 'linebreak',
            halign: 'left'
        },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            1: { cellWidth: 20 },
            2: { cellWidth: 22 },
            3: { cellWidth: 22 },
            4: { cellWidth: 18, halign: 'center' },
            5: { cellWidth: 22 },
            6: { cellWidth: 22 },
            7: { cellWidth: 22 },
            8: { cellWidth: 18, halign: 'center' },
            9: { cellWidth: 22 },
            10: { cellWidth: 22 },
            11: { cellWidth: 18, halign: 'center' },
            12: { cellWidth: 18, halign: 'center' }
        },
        tableWidth: 'auto', // CHANGED FROM 'wrap' TO 'auto' - This will stretch to fill available width
        showHead: 'everyPage', // Header on every page
        didDrawPage: function(data) {
            // Add page header on every page after first
            if (data.pageNumber > 1) {
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text('UMAS User Data Change Report - District Treasury Trivandrum', 148.5, 15, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(printedDate, 280, 15, { align: 'right' });
                
                doc.setFontSize(11);
                doc.text(`Date Range: ${$('#fromDate').val()} to ${$('#toDate').val()}`, 14, 25);
                doc.text(`Total Records: ${currentData.length}`, 250, 25, { align: 'right' });
                
                doc.setLineWidth(0.5);
                doc.line(14, 30, 277, 30);
            }
            
            // Add signature line at bottom right of each page
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            
            // Only add signature if we're not at the very bottom of content
            if (data.cursor.y < pageHeight - 40) {
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                
                // Draw line for signature
                doc.setLineWidth(0.5);
                doc.line(pageWidth - 60, pageHeight - 30, pageWidth - 20, pageHeight - 30);
                
                // Add signature text
                doc.text('District Treasury Officer', pageWidth - 40, pageHeight - 25, { align: 'center' });
                doc.text('District Treasury Trivandrum', pageWidth - 40, pageHeight - 20, { align: 'center' });
            }
            
            // Add page number (always at bottom)
            doc.setFontSize(8);
            doc.text(`Page ${data.pageNumber} of ${data.pageCount}`, pageWidth - 20, pageHeight - 10, { align: 'right' });
        },
        didParseCell: function(data) {
            // Reduce row height to fit more content
            data.cell.styles.minCellHeight = 5;
        },
        tableLineWidth: 0.1,
        tableLineColor: [0, 0, 0]
    });
    
    // Save PDF
    doc.save(`UMAS_Report_${dateStr.replace(/\//g, '-')}.pdf`);
}
    </script>
</body>
</html>
