<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">

    <!-- jQuery, Bootstrap, DataTables, SweetAlert, Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <style>
        .loading {
            display: none;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .select2-container .select2-selection--single {
            height: 37px !important;
            padding: 5px 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .select2-container .select2-selection__rendered {
            line-height: 28px !important;
        }
        .select2-container .select2-selection__arrow {
            height: 36px !important;
        }
    </style>
</head>
<body class="container py-4" style="background-color: #d7e2ff6e;min-width: 100%;">
    <div class="card p-4">
        <h5>PEN Wise Employee Search</h5><hr>
        <div class="row g-3">
            <div class="col-md-10">
                <label for="penNumber" class="form-label">PEN Number:</label>
                <input type="text" id="penNumber" class="form-control" placeholder="Enter PEN Number" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary" onclick="searchByPEN()">Search</button>
            </div>
        </div>
        
        <div class="loading mt-3"><img src="https://itcelldto.github.io/try/Spinner-3.gif">  Loading.Please wait...</div>
        <br>
        
        <div class="card p-4">
            <h5 id="resultHeading" class="" style="color: #5f87c5;">Employee Details <span id="employeeCount" style="font-size: 14px; color: #ff0000;"></span></h5>
            <hr> 
            <table id="resultTable" class="table table-striped table-bordered dataTable">
                <thead>
                    <tr>
                        <th>Treasury Name</th>
                        <th>PEN</th>
                        <th>Employee Name</th>
                        <th>Designation</th>
                        <th>Role</th>
                        <th>Role Status</th>
                        <th>Joined Date</th>
                        <th>Retirement Date</th>
                        <th>Phone Number</th>
                        <th>Email-ID</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody style="font-size: 12px;"></tbody>
            </table>
        </div>
    </div>
    	  
    <script>
    $(document).ready(function() {
        // Initialize any needed components
    });

    function searchByPEN() {
        let penNumber = $('#penNumber').val().trim();

        if (!penNumber) {
            Swal.fire('Error', 'Please enter a PEN Number', 'error');
            return;
        }

        $('.loading').show();

        let sheetId = "1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM";
        let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
        let range = "umas-onboard!A2:K"; // Fetch all relevant columns
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let rows = data.values || [];
                
                // Filter rows where PEN (column B) matches the search (case insensitive)
                let filteredRows = rows.filter(row => {
                    let rowPEN = row[1] ? row[1].toString().toLowerCase() : '';
                    return rowPEN.includes(penNumber.toLowerCase());
                });

                displayEmployeeResults(filteredRows);
                $('.loading').hide();
            })
            .catch(error => {
                console.error("Error fetching employee data: ", error);
                $('.loading').hide();
                Swal.fire('Error', 'Failed to fetch employee data', 'error');
            });
    }

    function displayEmployeeResults(data) {
        if ($.fn.DataTable.isDataTable('#resultTable')) {
            $('#resultTable').DataTable().destroy();
        }
        
        let tableBody = $("#resultTable tbody");
        tableBody.empty();

        data.forEach(row => {
            tableBody.append(`<tr>
                <td>${row[0] || ''}</td>
                <td>${row[1] || ''}</td>
                <td>${row[2] || ''}</td>
                <td>${row[3] || ''}</td>
                <td>${row[4] || ''}</td>
                <td>${row[5] || ''}</td>
                <td>${row[6] || ''}</td>
                <td>${row[7] || ''}</td>
                <td>${row[8] || ''}</td>
                <td>${row[9] || ''}</td>
                <td>${row[10] || ''}</td>
            </tr>`);
        });

        $('#employeeCount').text(`(${data.length} employees found)`);
        
        $('#resultTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            searching: true,
            ordering: true,
            destroy: true,
            scrollX: true
        });

        if (data.length === 0) {
            Swal.fire('No Records Found', 'No matching records found for the provided PEN number.', 'info');
        }
    }
    </script>
</body>
</html>
