<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Cell Attendance Marking System</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Your existing styles remain the same */
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        /* ... rest of your styles ... */
    </style>
</head>
<body>
    <!-- Your HTML structure remains the same -->
    <div class="container">
        <h1>Attendance Marking System</h1>
        <div class="form-group">
            <label for="attendanceId">Attendance ID (8 digits):</label>
            <input type="text" id="attendanceId" maxlength="8" placeholder="Enter your 8-digit ID">
        </div>
        
        <div id="userDetails">
            <img id="userImage" src="" alt="User Photo">
            <h3 id="userName"></h3>
        </div>
        
        <button id="getLocationBtn">Get My Location</button>
        <div id="location">Location not yet retrieved</div>
        <div id="allowedLocation">Allowed Location: Not loaded yet</div>
        
        <button id="markAttendanceBtn" disabled>Mark Attendance</button>
    </div>

    <script>
        // Google Sheets configuration
        const spreadsheetId = '12LIBVwVqQgDcqZkSSjOty2vLahViuEQOXGMw0bry5ts';
        const apiKey = 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4';
        const formResponsesSheet = 'Form responses 1';
        const dataSheet = 'DATA';
        const settingsSheet = 'settings';
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbzrUoEbkfV5uHdx-oHU5_d-lo8eR8u5lrkfFiDTcRvggj7qkSBWLBouYJxLVEyBirmDiA/exec';
        
        // DOM elements
        const attendanceIdInput = document.getElementById('attendanceId');
        const markAttendanceBtn = document.getElementById('markAttendanceBtn');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const locationDisplay = document.getElementById('location');
        const allowedLocationDisplay = document.getElementById('allowedLocation');
        const userDetailsDiv = document.getElementById('userDetails');
        const userImage = document.getElementById('userImage');
        const userName = document.getElementById('userName');
        
        // Location variables
        let userLocation = null;
        let cutoffTime = null;
        
        // Location range constants
        const MIN_LATITUDE = 8.0000;
        const MAX_LATITUDE = 77.0000;
        const MIN_LONGITUDE = 8.0000;
        const MAX_LONGITUDE = 77.0000;
        
        // Event listeners
        attendanceIdInput.addEventListener('input', fetchUserDetails);
        getLocationBtn.addEventListener('click', getLocation);
        markAttendanceBtn.addEventListener('click', markAttendance);
        
        // Initialize the page
        async function initialize() {
            try {
                // Get cutoff time from settings sheet
                const settingsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${settingsSheet}!B5?key=${apiKey}`;
                const settingsResponse = await fetch(settingsUrl);
                const settingsData = await settingsResponse.json();
                
                if (settingsData.values && settingsData.values.length >= 1) {
                    cutoffTime = settingsData.values[0][0]; // B5 cell contains cutoff time
                    allowedLocationDisplay.style.display = 'block';
                    allowedLocationDisplay.innerHTML = `
                        Allowed Location Range:<br>
                        Latitude: ${MIN_LATITUDE} to ${MAX_LATITUDE}<br>
                        Longitude: ${MIN_LONGITUDE} to ${MAX_LONGITUDE}<br>
                        Cutoff Time: ${cutoffTime} (IST)<br>
                        Time Zone: Indian Standard Time (IST)
                    `;
                } else {
                    allowedLocationDisplay.textContent = "Error: Could not load settings";
                    console.error('Could not retrieve settings from sheet');
                }
            } catch (error) {
                console.error('Error initializing:', error);
                allowedLocationDisplay.textContent = "Error loading settings";
            }
        }
        
        // Convert to IST (UTC+5:30)
        function toIST(date) {
            const offset = 5.5 * 60 * 60 * 1000; // IST offset in milliseconds
            return new Date(date.getTime() + offset);
        }
        
        // Format time in IST
        function formatTimeIST(date) {
            const istDate = toIST(date);
            return istDate.toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Format date in IST (DD/MM/YYYY)
        function formatDateIST(date) {
            const istDate = toIST(date);
            const day = String(istDate.getDate()).padStart(2, '0');
            const month = String(istDate.getMonth() + 1).padStart(2, '0');
            const year = istDate.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Determine FN/AN status based on cutoff time in IST
        function getAttendanceStatus() {
            if (!cutoffTime) return 'AN'; // Default to AN if no cutoff time
            
            const now = toIST(new Date());
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Parse cutoff time (assuming format HH:MM in 24-hour format)
            const [cutoffHour, cutoffMinute] = cutoffTime.split(':').map(Number);
            
            if (currentHour < cutoffHour || 
               (currentHour === cutoffHour && currentMinute < cutoffMinute)) {
                return 'FN';
            } else {
                return 'AN';
            }
        }
        
        // Rest of your functions remain the same until markAttendance()
        
        // Mark attendance using Google Web App (updated with IST)
        async function markAttendance() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'User details not found.',
                });
                return;
            }

            if (!isWithinAllowedLocation()) {
                Swal.fire({
                    icon: 'error',
                    title: 'Location Error',
                    html: `You are not within the allowed location range.<br><br>
                           Your location: ${userLocation.latitude}, ${userLocation.longitude}<br>
                           Allowed range: Latitude ${MIN_LATITUDE} to ${MAX_LATITUDE}, Longitude ${MIN_LONGITUDE} to ${MAX_LONGITUDE}`,
                });
                return;
            }

            try {
                const now = new Date();
                const dateStr = formatDateIST(now);
                const timeStr = formatTimeIST(now);
                const status = getAttendanceStatus();
                const locationId = `${userLocation.latitude.toFixed(6)},${userLocation.longitude.toFixed(6)}`;
                
                const uniqueUrl = `${webAppUrl}?cache=${Date.now()}`;
                
                const response = await fetch(uniqueUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        date: dateStr,
                        timestamp: now.toISOString(),
                        attendanceId: currentUser.id,
                        location: locationId,
                        status: status
                    })
                });

                Swal.fire({
                    title: 'Attendance Submitted!',
                    html: `
                        <div style="text-align: center;">
                            ${currentUser.photo ? `<img src="${currentUser.photo}" style="max-width: 200px; max-height: 200px; border-radius: 50%; margin-bottom: 15px;">` : ''}
                            <h3>${currentUser.name}</h3>
                            <p>ID: ${String(currentUser.id).padStart(8, '0')}</p>
                            <p>Date: ${dateStr}</p>
                            <p>Time: ${timeStr} (IST)</p>
                            <p>Status: ${status}</p>
                            <p>Location: ${locationId}</p>
                        </div>
                    `,
                    icon: 'success'
                });

                setTimeout(() => verifyAttendance(currentUser.id, now.toISOString()), 3000);
                
            } catch (error) {
                console.error('Error marking attendance:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while marking attendance. Please try again.',
                });
            }
        }

        // Keep all other functions the same (getLocation, validateForm, etc.)
        // ... [rest of your existing functions remain unchanged] ...

        // Initialize the page when loaded
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
