<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Marking System</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #location {
            margin: 15px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        #getLocationBtn {
            background-color: #2196F3;
        }
        #getLocationBtn:hover {
            background-color: #0b7dda;
        }
        #userDetails {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: none;
            text-align: center;
        }
        #userImage {
            max-width: 150px;
            max-height: 150px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        #allowedLocation {
            margin: 15px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Attendance Marking System</h1>
        <div class="form-group">
            <label for="attendanceId">Attendance ID (8 digits):</label>
            <input type="text" id="attendanceId" maxlength="8" placeholder="Enter your 8-digit ID">
        </div>
        
        <div id="userDetails">
            <img id="userImage" src="" alt="User Photo">
            <h3 id="userName"></h3>
        </div>
        
        <button id="getLocationBtn">Get My Location</button>
        <div id="location">Location not yet retrieved</div>
        <div id="allowedLocation">Allowed Location: Not loaded yet</div>
        
        <button id="markAttendanceBtn" disabled>Mark Attendance</button>
    </div>

    <script>
        // Google Sheets configuration
        const spreadsheetId = '12LIBVwVqQgDcqZkSSjOty2vLahViuEQOXGMw0bry5ts';
        const apiKey = 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4';
        const formResponsesSheet = 'Form responses 1';
        const dataSheet = 'DATA';
        const settingsSheet = 'settings';
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxluM7hCAGi2SP0ya9a4M0aN8Uw_IRRkT8OwLwPXWP-8eYtjE46jtoatfejX5rzGJkU3A/exec';
        
        // DOM elements
        const attendanceIdInput = document.getElementById('attendanceId');
        const markAttendanceBtn = document.getElementById('markAttendanceBtn');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const locationDisplay = document.getElementById('location');
        const allowedLocationDisplay = document.getElementById('allowedLocation');
        const userDetailsDiv = document.getElementById('userDetails');
        const userImage = document.getElementById('userImage');
        const userName = document.getElementById('userName');
        
        // Location variables
        let userLocation = null;
        let allowedLocation = {
            latitude: null,
            longitude: null
        };
        let currentUser = null;
        
        // Event listeners
        attendanceIdInput.addEventListener('input', fetchUserDetails);
        getLocationBtn.addEventListener('click', getLocation);
        markAttendanceBtn.addEventListener('click', markAttendance);
        
        // Initialize the page
        async function initialize() {
            try {
                // Get allowed location from settings sheet
                const settingsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${settingsSheet}!B2:B3?key=${apiKey}`;
                const settingsResponse = await fetch(settingsUrl);
                const settingsData = await settingsResponse.json();
                
                if (settingsData.values && settingsData.values.length >= 2) {
                    allowedLocation.latitude = parseFloat(settingsData.values[0][0]);
                    allowedLocation.longitude = parseFloat(settingsData.values[1][0]);
                    
                    allowedLocationDisplay.style.display = 'block';
                    allowedLocationDisplay.innerHTML = `
                        Allowed Location:<br>
                        Latitude: ${allowedLocation.latitude}<br>
                        Longitude: ${allowedLocation.longitude}
                    `;
                } else {
                    allowedLocationDisplay.textContent = "Error: Could not load allowed location from settings";
                    console.error('Could not retrieve allowed location from settings sheet');
                }
            } catch (error) {
                console.error('Error initializing:', error);
                allowedLocationDisplay.textContent = "Error loading allowed location settings";
            }
        }
        
        // Fetch user details when ID is entered
        async function fetchUserDetails() {
            const attendanceId = attendanceIdInput.value;
            
            if (attendanceId.length !== 8 || !/^\d+$/.test(attendanceId)) {
                userDetailsDiv.style.display = 'none';
                currentUser = null;
                validateForm();
                return;
            }
            
            try {
                // Corrected range to get columns B (ID), C (Name), and E (Photo)
                const userDetailsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${formResponsesSheet}!B2:E?key=${apiKey}`;
                const detailsResponse = await fetch(userDetailsUrl);
                const detailsData = await detailsResponse.json();
                
                if (detailsData.values) {
                    const userRow = detailsData.values.find(row => row[0] === attendanceId);
                    if (userRow) {
                        currentUser = {
                            id: userRow[0],      // Column B (Attendance ID)
                            name: userRow[1],    // Column C (Name) - CORRECTED
                            photo: userRow[3]    // Column E (Photograph URL)
                        };
                        
                        userImage.src = currentUser.photo;
                        userName.textContent = currentUser.name;
                        userDetailsDiv.style.display = 'block';
                    } else {
                        userDetailsDiv.style.display = 'none';
                        currentUser = null;
                    }
                } else {
                    userDetailsDiv.style.display = 'none';
                    currentUser = null;
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
                userDetailsDiv.style.display = 'none';
                currentUser = null;
            }
            
            validateForm();
        }
        
        // Get user's current location
        function getLocation() {
            locationDisplay.textContent = "Retrieving location...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        locationDisplay.innerHTML = 
                            `Your Location:<br>
                             Latitude: ${userLocation.latitude}<br>
                             Longitude: ${userLocation.longitude}`;
                        validateForm();
                    },
                    (error) => {
                        let errorMessage = 'Error retrieving location: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += "User denied the request for Geolocation.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += "Location information is unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage += "The request to get user location timed out.";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage += "An unknown error occurred.";
                                break;
                        }
                        locationDisplay.textContent = errorMessage;
                        userLocation = null;
                        validateForm();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                locationDisplay.textContent = "Geolocation is not supported by this browser.";
                userLocation = null;
                validateForm();
            }
        }
        
        // Validate form inputs
        function validateForm() {
            const idValid = attendanceIdInput.value.length === 8 && /^\d+$/.test(attendanceIdInput.value) && currentUser;
            const locationValid = userLocation !== null;
            
            markAttendanceBtn.disabled = !(idValid && locationValid);
        }
        
        // Calculate distance between two coordinates in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Check if user is within allowed location
        function isWithinAllowedLocation() {
            if (!userLocation || !allowedLocation.latitude || !allowedLocation.longitude) {
                console.error('Missing location data for verification');
                return false;
            }
            
            const distance = calculateDistance(
                userLocation.latitude, userLocation.longitude,
                allowedLocation.latitude, allowedLocation.longitude
            );
            
            console.log(`Distance from allowed location: ${distance.toFixed(2)} meters`);
            return distance <= 100; // 100 meters radius
        }
        
      // Replace your markAttendance function with this:
async function markAttendance() {
    if (!currentUser) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'User details not found.',
        });
        return;
    }

    // First verify location
    if (!isWithinAllowedLocation()) {
        Swal.fire({
            icon: 'error',
            title: 'Location Error',
            html: `You are not at the allowed location.<br><br>
                   Your location: ${userLocation.latitude}, ${userLocation.longitude}<br>
                   Allowed location: ${allowedLocation.latitude}, ${allowedLocation.longitude}`,
        });
        return;
    }

    try {
        const timestamp = new Date().toISOString();
        const locationId = `${userLocation.latitude.toFixed(6)},${userLocation.longitude.toFixed(6)}`;
        
        // Create a unique URL to bypass CORS caching
        const uniqueUrl = `${webAppUrl}?origin=${encodeURIComponent(window.location.origin)}&cache=${Date.now()}`;
        
        // Submit via Google Web App with CORS handling
        const response = await fetch(uniqueUrl, {
            method: 'POST',
            mode: 'no-cors', // Important for CORS
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                timestamp: timestamp,
                attendanceId: currentUser.id,
                location: locationId
            })
        });

        // Since we're using no-cors, we can't read the response directly
        // So we'll assume success and verify later
        Swal.fire({
            title: 'Attendance Submitted!',
            html: `
                <div style="text-align: center;">
                    ${currentUser.photo ? `<img src="${currentUser.photo}" style="max-width: 200px; max-height: 200px; border-radius: 50%; margin-bottom: 15px;">` : ''}
                    <h3>${currentUser.name}</h3>
                    <p>ID: ${currentUser.id}</p>
                    <p>Time: ${new Date(timestamp).toLocaleString()}</p>
                    <p>Location: ${locationId}</p>
                </div>
            `,
            icon: 'success'
        });

        // Alternative: Verify submission by checking the sheet after a delay
        setTimeout(() => verifyAttendance(currentUser.id, timestamp), 3000);
        
    } catch (error) {
        console.error('Error marking attendance:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while marking attendance. Please try again.',
        });
    }
}

// Optional verification function
async function verifyAttendance(attendanceId, timestamp) {
    try {
        const verificationUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${dataSheet}!B2:C?key=${apiKey}`;
        const response = await fetch(verificationUrl);
        const data = await response.json();
        
        if (data.values) {
            const record = data.values.find(row => 
                row[0] === attendanceId && row[1] === timestamp
            );
            
            if (!record) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Verification Pending',
                    text: 'Attendance submission is being processed. Please check back later.',
                });
            }
        }
    } catch (error) {
        console.log('Verification error:', error);
    }
}
        
        // Initialize the page when loaded
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
