<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Marking System</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #userDetails {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: none;
            text-align: center;
        }
        #userImage {
            max-width: 150px;
            max-height: 150px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Attendance Marking System</h1>
        <div class="form-group">
            <label for="attendanceId">Attendance ID (8 digits):</label>
            <input type="text" id="attendanceId" maxlength="8" placeholder="Enter your 8-digit ID">
        </div>
        
        <div id="userDetails">
            <img id="userImage" src="" alt="User Photo">
            <h3 id="userName"></h3>
        </div>
        
        <button id="markAttendanceBtn" disabled>Mark Attendance</button>
    </div>

    <script>
        // Configuration
        const spreadsheetId = '12LIBVwVqQgDcqZkSSjOty2vLahViuEQOXGMw0bry5ts';
        const apiKey = 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4';
        const formResponsesSheet = 'Form responses 1';
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbzM_u6seN_hkYjlE0euxHQuItyF-j9c2oXDNWC7879YvmaQbOPG31XafJIlq0H0Dy90vA/exec';
        
        // DOM elements
        const attendanceIdInput = document.getElementById('attendanceId');
        const markAttendanceBtn = document.getElementById('markAttendanceBtn');
        const userDetailsDiv = document.getElementById('userDetails');
        const userImage = document.getElementById('userImage');
        const userName = document.getElementById('userName');
        
        // Variables
        let currentUser = null;
        let allowedLocation = {
            latitude: null,
            longitude: null
        };
        
        // Event listeners
        attendanceIdInput.addEventListener('input', fetchUserDetails);
        markAttendanceBtn.addEventListener('click', markAttendance);
        
        // Initialize the page
        async function initialize() {
            try {
                // Get allowed location from settings sheet
                const settingsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/settings!B2:B3?key=${apiKey}`;
                const settingsResponse = await fetch(settingsUrl);
                const settingsData = await settingsResponse.json();
                
                if (settingsData.values && settingsData.values.length >= 2) {
                    allowedLocation.latitude = parseFloat(settingsData.values[0][0]);
                    allowedLocation.longitude = parseFloat(settingsData.values[1][0]);
                }
            } catch (error) {
                console.error('Error loading allowed location settings:', error);
            }
        }
        
        // Fetch user details when ID is entered
        async function fetchUserDetails() {
            const attendanceId = attendanceIdInput.value;
            
            if (attendanceId.length !== 8 || !/^\d+$/.test(attendanceId)) {
                userDetailsDiv.style.display = 'none';
                currentUser = null;
                markAttendanceBtn.disabled = true;
                return;
            }
            
            try {
                const userDetailsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${formResponsesSheet}!B2:E?key=${apiKey}`;
                const detailsResponse = await fetch(userDetailsUrl);
                const detailsData = await detailsResponse.json();
                
                if (detailsData.values) {
                    const userRow = detailsData.values.find(row => row[0] === attendanceId);
                    if (userRow) {
                        currentUser = {
                            id: userRow[0],      // Column B (Attendance ID)
                            name: userRow[1],    // Column C (Name)
                            photo: userRow[3]     // Column E (Photograph URL)
                        };
                        
                        userImage.src = currentUser.photo;
                        userName.textContent = currentUser.name;
                        userDetailsDiv.style.display = 'block';
                        markAttendanceBtn.disabled = false;
                    } else {
                        userDetailsDiv.style.display = 'none';
                        currentUser = null;
                        markAttendanceBtn.disabled = true;
                    }
                } else {
                    userDetailsDiv.style.display = 'none';
                    currentUser = null;
                    markAttendanceBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
                userDetailsDiv.style.display = 'none';
                currentUser = null;
                markAttendanceBtn.disabled = true;
            }
        }
        
        // Get user's current location
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };
                            resolve(userLocation);
                        },
                        (error) => {
                            let errorMessage = 'Error retrieving location: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += "User denied the request for Geolocation.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += "Location information is unavailable.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += "The request to get user location timed out.";
                                    break;
                                case error.UNKNOWN_ERROR:
                                    errorMessage += "An unknown error occurred.";
                                    break;
                            }
                            reject(new Error(errorMessage));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    reject(new Error("Geolocation is not supported by this browser."));
                }
            });
        }
        
        // Calculate distance between two coordinates in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Check if user is within allowed location
        function isWithinAllowedLocation(userLocation) {
            if (!userLocation || !allowedLocation.latitude || !allowedLocation.longitude) {
                return false;
            }
            
            const distance = calculateDistance(
                userLocation.latitude, userLocation.longitude,
                allowedLocation.latitude, allowedLocation.longitude
            );
            
            return distance <= 100; // 100 meters radius
        }
        
        // Mark attendance using Google Web App
        async function markAttendance() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'User details not found.',
                });
                return;
            }

            try {
                // Get user location
                const userLocation = await getLocation();
                
                // Verify location
                if (!isWithinAllowedLocation(userLocation)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Location Error',
                        text: 'You are not at the allowed location to mark attendance.',
                    });
                    return;
                }
                
                const locationId = `${userLocation.latitude.toFixed(6)},${userLocation.longitude.toFixed(6)}`;
                
                // Create a unique URL to prevent caching
                const uniqueUrl = `${webAppUrl}?cache=${Date.now()}`;
                
                // Submit via Google Web App with CORS handling
                const response = await fetch(uniqueUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        attendanceId: currentUser.id,
                        location: locationId
                    })
                });

                // Since we're using no-cors, we can't read the response directly
                // So we'll assume success and verify later
                const now = new Date();
                const options = { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true
                };
                const formattedTime = now.toLocaleString('en-IN', options);
                
                Swal.fire({
                    title: 'Attendance Submitted!',
                    html: `
                        <div style="text-align: center;">
                            ${currentUser.photo ? `<img src="${currentUser.photo}" style="max-width: 200px; max-height: 200px; border-radius: 50%; margin-bottom: 15px;">` : ''}
                            <h3>${currentUser.name}</h3>
                            <p>ID: ${String(currentUser.id).padStart(8, '0')}</p>
                            <p>Time: ${formattedTime}</p>
                        </div>
                    `,
                    icon: 'success'
                });

                // Alternative: Verify submission by checking the sheet after a delay
                setTimeout(() => verifyAttendance(currentUser.id, now.toISOString()), 3000);
                
            } catch (error) {
                console.error('Error marking attendance:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'An error occurred while marking attendance. Please try again.',
                });
            }
        }

        // Optional verification function
        async function verifyAttendance(attendanceId, timestamp) {
            try {
                const verificationUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/DATA!B2:C?key=${apiKey}`;
                const response = await fetch(verificationUrl);
                const data = await response.json();
                
                if (data.values) {
                    const record = data.values.find(row => 
                        row[0] === attendanceId && row[1] === timestamp
                    );
                    
                    if (!record) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Verification Pending',
                            text: 'Attendance submission is being processed. Please check back later.',
                        });
                    }
                }
            } catch (error) {
                console.log('Verification error:', error);
            }
        }
        
        // Initialize the page when loaded
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
