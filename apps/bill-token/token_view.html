<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Search | IT Cell Treasury</title>
    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    
    <!-- jQuery, Bootstrap, DataTables, SweetAlert, Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    
    <!-- jQuery UI Datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	
	 <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        .loading {
            display: none;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .select2-container .select2-selection--single {
        height: 37px !important;
        padding: 5px 10px;
        border: 1px solid #ced4da;
        border-radius: 5px;
    }
    .select2-container .select2-selection__rendered {
        line-height: 28px !important;
    }
    .select2-container .select2-selection__arrow {
        height: 36px !important;
    }
	  .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
	  .pdf-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .pdf-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body class="container py-4" style="background-color: #d7e2ff6e;min-width: 100%;">
    <div class="card p-4">
        <h5>Date Wise Token Search</h5><hr>
        <div class="row g-3">
            <div class="col-md-3">
                <label for="fromDate" class="form-label">From Date:</label>
                <input type="text" id="fromDate" class="form-control" placeholder="DD/MM/YYYY" required>
            </div>
            <div class="col-md-3">
                <label for="toDate" class="form-label">To Date:</label>
                <input type="text" id="toDate" class="form-control" placeholder="DD/MM/YYYY" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary" onclick="searchData()">View</button>
            </div>
        </div>
        <div class="loading mt-3"><img src="https://itcelldto.github.io/try/Spinner-3.gif">  Loading.Please wait...</div>
        <br>

        <div class="card p-4">
		        <div class="result-header">
            <h5 id="resultHeading" style="color: #5f87c5;">Bill Details <span id="billCount" style="font-size: 14px; color: #ff0000;"></span></h5>
			 <button id="pdfButton" class="pdf-btn" style="display: none;">Download PDF</button>
            </div>
			<hr>
            <div class="table-responsive"> <!-- Added table-responsive wrapper -->
                <table id="resultTable" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Time</th>
                            <th>DDO</th>
                            <th>Office</th>
                            <th>BRN</th>
                            <th>Bill Type</th>
                            <th>Nature</th>
                            <th>Gross</th>
                            <th>Module</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody style="font-size: 12px;"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" class="text-end fw-bold">Total:</td>
                            <td id="grandTotal" class="fw-bold" style="color:green">0.00</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <script>
     let currentData = []; // Store current table data for PDF export
    $(document).ready(function () {
        // Initialize jQuery UI Datepicker
        $("#fromDate, #toDate").datepicker({
            dateFormat: "dd/mm/yy",
            changeMonth: true,
            changeYear: true
        });
         // Set default dates
    setDefaultDates();
	  // Initialize PDF button click handler
            $('#pdfButton').click(generatePDF);
    });

  function setDefaultDates() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    // Format today as DD/MM/YYYY
    const toDateStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
    
    // Format last month as DD/MM/YYYY
    const fromDateStr = `${String(lastMonth.getDate()).padStart(2, '0')}/${String(lastMonth.getMonth() + 1).padStart(2, '0')}/${lastMonth.getFullYear()}`;
    
    $('#toDate').val(toDateStr);
    $('#fromDate').val(fromDateStr);
}
        
    function searchData() {
        let fromDateInput = $('#fromDate').val();
        let toDateInput = $('#toDate').val();

        if (!fromDateInput || !toDateInput) {
            Swal.fire('Error', 'Please enter both From Date and To Date', 'error');
            return;
        }

        let fromDate = parseDate(fromDateInput);
        let toDate = parseDate(toDateInput);

        $('.loading').show();

        let sheetId = "1IVNc7bKiWxrulGgdcpb4rNKVhfCIzPoBRLli1SZZcr8";
        let apiKey = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
        let range = "DB!A:L";
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let rows = data.values || [];
                rows.shift();

                let filteredRows = rows.filter(row => {
                    let rowFromDate = parseDate(row[10]);
                    let rowToDate = parseDate(row[11]);
                    return rowFromDate >= fromDate && rowToDate <= toDate;
                });
                   currentData = filteredRows; // Store data for PDF export
                displayResults(filteredRows);
                $('.loading').hide();
				 // Show PDF button if there are results
                    if (filteredRows.length > 0) {
                        $('#pdfButton').show();
                    } else {
                        $('#pdfButton').hide();
                    }
                 // Call the new function to update heading
           // updateResultHeading(officeName, filteredRows.length, totalGrossAmount);
            })
            .catch(error => {
                console.error("Error fetching data: ", error);
                $('.loading').hide();
				   $('#pdfButton').hide();
            });
    }
    function updateResultHeading(officeName, totalBills, totalGrossAmount) {
    if (totalBills > 0) {
        $("#resultHeading").html(`${officeName} - Total Bills: ${totalBills}, Gross Total: â‚¹${totalGrossAmount.toFixed(2)}`);
    } else {
        $("#resultHeading").html("Results");
    }
}
    function parseDate(dateStr) {
        if (!dateStr) return new Date(0);
        let parts = dateStr.split('/');
        return new Date(parts[2], parts[1] - 1, parts[0]); // yyyy, mm-1, dd
    }

    function displayResults(data) {
        if ($.fn.DataTable.isDataTable('#resultTable')) {
            $('#resultTable').DataTable().destroy();
        }
        
        let tableBody = $("#resultTable tbody");
        tableBody.empty();
        let totalGrossAmount = 0;

        data.forEach(row => {
            totalGrossAmount += parseFloat(row[7]) || 0;
            tableBody.append(`<tr>
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
                <td>${row[6]}</td>
                <td>${row[7]}</td>
                <td>${row[8]}</td>
                <td>${row[9]}</td>
            </tr>`);
        });

        $('#grandTotal').text(totalGrossAmount.toFixed(2));
        $('#billCount').text(`(${data.length} bills found)`);
        
        $('#resultTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            searching: true,
            ordering: true,
            destroy: true
        });

        if (data.length === 0) {
            Swal.fire('No Records Found', 'No matching records found for the selected criteria.', 'info');
        }
    }
	
	function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });
    
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    
    const pdfData = currentData.map((row, index) => {
        const ddoCode = row[2];
     //   const headOfAccount = headOfAccountCache[ddoCode] || row[6];
        
        return [
            index + 1,
            row[0],
            row[1],
            row[2],
            row[3],
            row[4],
            row[5],
             row[6],
			  row[7],
			   row[8],
            '' + parseFloat(row[7] || 0).toFixed(2) // Changed from â‚¹ to Rs.
        ];
    });
    
    const totalGross = currentData.reduce((sum, row) => sum + (parseFloat(row[7]) || 0), 0);
    
    doc.setFontSize(14);
    doc.text('Bill Date Wise Token Report', 105, 15, { align: 'center' });
    
    doc.setFontSize(10);
    //doc.text(`Bill Nature: ${$('#ddoCode').val()}`, 14, 25);
    doc.text(`Date Range: ${$('#fromDate').val()} to ${$('#toDate').val()}`, 14, 30);
    doc.text(`Total Bills: ${currentData.length}`, 14, 35);
    doc.text(`Total Gross Amount: Rs. ${totalGross.toFixed(2)}`, 14, 40); // Changed here too
    
    doc.autoTable({
        startY: 45,
        head: [['S.No', 'Token', 'Time', 'DDO', 'Office', 'BRN', 'Bill Type', 'Bill Nature', 'Gross (Rs.)']], // Changed header
        body: pdfData,
        theme: 'grid',
        didParseCell: function(data) {
            // Prevent automatic footnote generation
            if (data.cell.text) {
                data.cell.text = data.cell.text.map(t => t.toString().replace(/Â¹/g, ''));
            }
        },
        headStyles: {
            fillColor: [200, 200, 200],
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            fontSize: 8
        },
        styles: {
            cellPadding: 2,
            fontSize: 7,
            textColor: [0, 0, 0],
            lineColor: [0, 0, 0],
            lineWidth: 0.1
        },
        columnStyles: {
            0: { cellWidth: 10, halign: 'center' },
            1: { cellWidth: 13, halign: 'center' },
            2: { cellWidth: 18, halign: 'center' },
            3: { cellWidth: 20 },
            4: { cellWidth: 25 },
            5: { cellWidth: 32, halign: 'center' },
            6: { cellWidth: 15 },
            7: { cellWidth: 30 },
            8: { cellWidth: 20, halign: 'right' }
        },
        margin: { left: 10, right: 10 },
        tableWidth: 'wrap'
    });
    
    doc.autoTable({
        startY: doc.lastAutoTable.finalY,
        body: [['', '', '', '', '', '', '', 'Total:', 'Rs. ' + totalGross.toFixed(2)]], // Changed here
        styles: {
            fontStyle: 'bold',
            textColor: [0, 0, 0],
            fontSize: 8
        },
        columnStyles: {
            8: { halign: 'right' }
        },
        margin: { left: 10, right: 10 }
    });
    
    doc.save(`Bill_date_wise_Report_${dateStr}.pdf`);
}
    </script>
</body>
</html>
