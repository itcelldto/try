<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Revision Calculator</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: .2rem 0;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: .6rem .6rem 2rem;
			font-weight: 400;
        }
        .fw-bold {
         font-weight: 400 !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
           
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .calculation-period {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .table thead {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .table tbody tr:nth-child(even) {
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .total-row {
            font-weight: bold;
            background-color: rgba(52, 152, 219, 0.2) !important;
        }
        
        .icon-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 1.5rem 0;
            margin-top: 2rem;
            border-radius: 20px 20px 0 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            color: #777;
        }
        
        .step.active .step-number {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
        }
        
        .step-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #777;
        }
        
        .step.active .step-label {
            color: var(--primary-color);
        }
        
        .editable-input {
            width: 100%;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            background-color: white;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .print-only {
            display: none;
        }
        
        .flatpickr-input {
            background-color: white;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            .table {
                border: 1px solid #000;
            }
            .table th, .table td {
                border: 1px solid #000;
            }
        }
        
        @media (max-width: 768px) {
            .step-label {
                font-size: 0.8rem;
            }
        }
		.table>:not(caption)>*>* {
    padding: .2rem .2rem;
    background-color: var(--bs-table-bg);
    border-bottom-width: var(--bs-border-width);
    box-shadow: inset 0 0 0 9999px var(--bs-table-accent-bg);
}
    </style>
</head>
<body>
    <div class="header no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold"><i class="bi bi-calculator-fill"></i> Pension Revision Calculator</h1>
                    
                </div>
				<!--
                <div class="col-md-4 text-md-end">
                    <div class="bg-light text-dark p-3 rounded d-inline-block">
                        <h6 class="mb-1">Quick Calculation</h6>
                        <small>Fill form & generate PDF report</small>
                    </div>
                </div>-->
            </div>
        </div>
    </div>

    <div class="container no-print"style="min-width: 100%;">
        <!-- Step Indicator 
        <div class="step-indicator">
            <div class="step active">
                <div class="step-number">1</div>
                <div class="step-label">Pensioner Details</div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-label">Calculation Period</div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-label">DR Table</div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-label">Generate PDF</div>
            </div>
        </div> -->

        <!-- Calculation Period Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="icon-container">
                        <i class="bi bi-calendar-range"></i>
                    </div>
                    <h5 class="mb-0">Calculation Period</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="fromDate" class="form-label">From</label>
                        <input type="text" class="form-control flatpickr-input" id="fromDate" placeholder="Select From Date">
                    </div>
                    <div class="col-md-6">
                        <label for="toDate" class="form-label">To</label>
                        <input type="text" class="form-control flatpickr-input" id="toDate" placeholder="Select To Date">
                    </div>
                </div>
                
                <div class="calculation-period mt-4">
                  <!--  <h6 class="mb-3">Period Breakdown</h6> -->
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Years</label>
                            <input type="text" class="form-control" id="years" >
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Months</label>
                            <input type="text" class="form-control" id="months" >
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Days</label>
                            <input type="text" class="form-control" id="days">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pensioner Details Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="icon-container">
                        <i class="bi bi-person-vcard"></i>
                    </div>
                    <h5 class="mb-0">Pensioner Details</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="treasury" class="form-label">Treasury</label>
                        <select class="form-select" id="treasury">
                            <option value="">Loading treasuries...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="pensionerType" class="form-label">Pensioner Type</label>
                        <select class="form-select" id="pensionerType">
                            <option value="">Loading pension types...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="pensionerCode" class="form-label">Pensioner Code</label>
                        <input type="text" class="form-control" id="pensionerCode" placeholder="Enter pensioner code">
                    </div>
                    <div class="col-md-4">
                        <label for="pensionerName" class="form-label">Pensioner Name</label>
                        <input type="text" class="form-control" id="pensionerName" placeholder="Enter pensioner name">
                    </div>
                    <div class="col-md-4">
                        <label for="basicPension" class="form-label">Basic Pension</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="basicPension" placeholder="Enter basic pension amount" value="">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="drawnDR" class="form-label">DR% - Actual</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="drawnDR" placeholder="Enter DR%" value="">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DR Table Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="icon-container">
                        <i class="bi bi-table"></i>
                    </div>
                    <h5 class="mb-0">Calculation Table</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info" id="drTableStatus">
                    Please select a pensioner type to Proceed..
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="drTable" style="display: none;">
                        <thead>
                            <tr>
                                <th colspan="4" class="text-center">Due Details</th>
                                <th colspan="4" class="text-center">Drawn Details</th>
                                <th colspan="4" class="text-center">Difference Details</th>
                            </tr>
                            <tr>
                                <th>From Date</th>
                                <th>To Date</th>
                                <th>Basic Pension (Due)</th>
                                <th>DR% - Due</th>
                                <th>Amount Due</th>
                                <th>Basic Pension (Drawn)</th>
                                <th>DR% Drawn</th>
                                <th>Amount Drawn</th>
                                <th>Difference</th>
                                <th>No. of Months</th>
                                <th>Gross Amount</th>
                            </tr>
                        </thead>
                        <tbody id="drTableBody"style="font-size: 12px;">
                            <!-- Table rows will be generated dynamically -->
                        </tbody>
                        <tfoot id="drTableFooter">
                            <!-- Footer with grand total will be generated dynamically -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mb-5">
            <button class="btn btn-outline-secondary" id="resetBtn">
                <i class="bi bi-arrow-clockwise"></i> Reset 
            </button>
            <div>
                <button class="btn btn-primary me-2" id="calculateBtn">
                    <i class="bi bi-calculator"></i> Calculate
                </button>
                <button class="btn btn-danger" id="printBtn">
                    <i class="bi bi-printer"></i> Print 
                </button>
            </div>
        </div>
    </div>

    <!-- Print Section -->
    <div class="print-section" id="printSection" style="display: none;">
        <div class="container">
            <div class="text-center mb-4">
                <h1 class="print-only">Pension Revision</h1>
                <div class="row mt-4">
                    <div class="col-md-6 text-start">
                        <p><strong>Name of Pensioner:</strong> <span id="printPensionerName"></span></p>
                    </div>
                    <div class="col-md-6 text-start">
                        <p><strong>Pensioner Code:</strong> <span id="printPensionerCode"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-start">
                        <p><strong>Calculation Period:</strong> From <span id="printFromDate"></span> To <span id="printToDate"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th colspan="4" class="text-center">Due Details</th>
                            <th colspan="4" class="text-center">Drawn Details</th>
                            <th colspan="4" class="text-center">Difference Details</th>
                        </tr>
                        <tr>
                            <th>From Date</th>
                            <th>To Date</th>
                            <th>Basic Pension(Due)</th>
                            <th>DR% - Due</th>
                            <th>Amount Due</th>
                            <th>Basic Pension(Drawn)</th>
                            <th>DR% Drawn</th>
                            <th>Amount Drawn</th>
                            <th>Difference</th>
                            <th>No. of Months</th>
                            <th>Gross Amount</th>
                        </tr>
                    </thead>
                    <tbody id="printTableBody">
                        <!-- Print table rows will be generated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<!--
    <div class="footer no-print">
        <div class="container text-center">
           
        </div>
    </div>
-->
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Global variables
        let drData = [];
        let tableRows = [];
        let settingsData = {
            treasuries: [],
            pensionerTypes: []
        };

        // Google Sheets configuration
        const SHEET_ID = "11oRitOvxaUmQIP6cAFBBTBXMnSV_ZIw6DD9aL_RpILc";
        const API_KEY = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize flatpickr for date inputs
            flatpickr("#fromDate", {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                defaultDate: new Date(new Date().getFullYear() - 1, new Date().getMonth(), 1)
            });
            
            flatpickr("#toDate", {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                defaultDate: new Date()
            });
            
            // Initialize date inputs and calculate period
            initializeDates();
            
            // Set up event listeners
            document.getElementById('fromDate').addEventListener('change', calculatePeriod);
            document.getElementById('toDate').addEventListener('change', calculatePeriod);
            document.getElementById('calculateBtn').addEventListener('click', calculateRevision);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('printBtn').addEventListener('click', printCalculation);
            document.getElementById('pensionerType').addEventListener('change', fetchDRData);
            
            // Fetch settings data from Google Sheets
            fetchSettingsData();
        });

        // Initialize dates for calculation period
        function initializeDates() {
            // Calculate initial period
            calculatePeriod();
        }

        // Calculate period when dates change
        function calculatePeriod() {
            const fromDateInput = document.getElementById('fromDate');
            const toDateInput = document.getElementById('toDate');
            const yearsInput = document.getElementById('years');
            const monthsInput = document.getElementById('months');
            const daysInput = document.getElementById('days');
            
            const fromDate = new Date(fromDateInput.value);
            const toDate = new Date(toDateInput.value);
            
            if (fromDate && toDate && fromDate <= toDate) {
                let years = toDate.getFullYear() - fromDate.getFullYear();
                let months = toDate.getMonth() - fromDate.getMonth();
                let days = toDate.getDate() - fromDate.getDate();
                
                if (days < 0) {
                    months--;
                    // Get days in the previous month
                    const prevMonth = new Date(toDate.getFullYear(), toDate.getMonth(), 0);
                    days += prevMonth.getDate();
                }
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                yearsInput.value = years;
                monthsInput.value = months;
                daysInput.value = days;
            }
        }

        // Fetch settings data from Google Sheets
        async function fetchSettingsData() {
            try {
                showLoadingState(true);
                
                // Fetch data from Settings sheet - Column A (Treasuries)
                const treasuryResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Settings!A2:A?key=${API_KEY}`);
                const treasuryData = await treasuryResponse.json();
                
                // Fetch data from Settings sheet - Column B (Pensioner Types)
                const pensionTypeResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Settings!B2:B?key=${API_KEY}`);
                const pensionTypeData = await pensionTypeResponse.json();
                
                // Process the data
                settingsData.treasuries = treasuryData.values ? treasuryData.values.flat().filter(val => val.trim() !== '') : [];
                settingsData.pensionerTypes = pensionTypeData.values ? pensionTypeData.values.flat().filter(val => val.trim() !== '') : [];
                
                // Populate the dropdowns
                populateSettingsDropdowns();
                showLoadingState(false);
                
            } catch (error) {
                console.error('Error fetching settings data:', error);
                document.getElementById('treasury').innerHTML = '<option value="">Error loading treasuries</option>';
                document.getElementById('pensionerType').innerHTML = '<option value="">Error loading pension types</option>';
                showLoadingState(false);
            }
        }

        // Show/hide loading state
        function showLoadingState(isLoading) {
            const treasurySelect = document.getElementById('treasury');
            const pensionTypeSelect = document.getElementById('pensionerType');
            
            if (isLoading) {
                treasurySelect.innerHTML = '<option value="">Loading treasuries...</option>';
                pensionTypeSelect.innerHTML = '<option value="">Loading pension types...</option>';
                treasurySelect.disabled = true;
                pensionTypeSelect.disabled = true;
            } else {
                treasurySelect.disabled = false;
                pensionTypeSelect.disabled = false;
            }
        }

        // Populate settings dropdowns
        function populateSettingsDropdowns() {
            const treasurySelect = document.getElementById('treasury');
            const pensionerTypeSelect = document.getElementById('pensionerType');
            
            // Clear existing options
            treasurySelect.innerHTML = '<option value="">Select Treasury</option>';
            pensionerTypeSelect.innerHTML = '<option value="">Select Pensioner Type</option>';
            
            // Add treasury options
            settingsData.treasuries.forEach(treasury => {
                const option = document.createElement('option');
                option.value = treasury;
                option.textContent = treasury;
                treasurySelect.appendChild(option);
            });
            
            // Add pensioner type options
            settingsData.pensionerTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                pensionerTypeSelect.appendChild(option);
            });
        }

        // Fetch DR data from Google Sheets based on selected pensioner type
        async function fetchDRData() {
            const pensionerType = document.getElementById('pensionerType').value;
            
            if (!pensionerType) {
                // Clear table if no pensioner type selected
                clearDRTable();
                document.getElementById('drTableStatus').textContent = 'Please select a pensioner type to load DR data';
                document.getElementById('drTableStatus').className = 'alert alert-info';
                document.getElementById('drTable').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('drTableStatus').textContent = 'Loading DR data...';
                document.getElementById('drTableStatus').className = 'alert alert-warning';
                
                // Fetch DR data from the sheet named after the pensioner type
                const drResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${pensionerType}!A2:D?key=${API_KEY}`);
                const drDataResponse = await drResponse.json();
                
                if (!drDataResponse.values || drDataResponse.values.length === 0) {
                    document.getElementById('drTableStatus').textContent = 'No DR data available for selected pension type';
                    document.getElementById('drTableStatus').className = 'alert alert-warning';
                    document.getElementById('drTable').style.display = 'none';
                    drData = [];
                    return;
                }
                
                // Process DR data
                drData = drDataResponse.values.map(row => ({
                    fromDate: row[0] || '',
                    toDate: row[1] || '',
                    dueBasicPension: parseFloat(row[2]) || 0,
                    drDue: parseFloat(row[3]) || 0
                })).filter(item => item.fromDate && item.toDate);
                
                // Filter DR data based on calculation period
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                
                if (fromDate && toDate) {
                    drData = filterDRDataByDateRange(drData, fromDate, toDate);
                }
                
                if (drData.length === 0) {
                    document.getElementById('drTableStatus').textContent = 'No DR details available for the selected date range';
                    document.getElementById('drTableStatus').className = 'alert alert-warning';
                    document.getElementById('drTable').style.display = 'none';
                } else {
                    document.getElementById('drTableStatus').textContent = `Loaded ${drData.length} DR record(s) for ${pensionerType}`;
                    document.getElementById('drTableStatus').className = 'alert alert-success';
                    document.getElementById('drTable').style.display = 'table';
                }
                
                // Populate the table with editable fields
                populateDRTable();
                
            } catch (error) {
                console.error('Error fetching DR data:', error);
                document.getElementById('drTableStatus').textContent = 'Error loading DR data. Please try again.';
                document.getElementById('drTableStatus').className = 'alert alert-danger';
                document.getElementById('drTable').style.display = 'none';
                drData = [];
            }
        }

        // Filter DR data by date range
        function filterDRDataByDateRange(data, fromDate, toDate) {
            const from = new Date(fromDate);
            const to = new Date(toDate);
            
            return data.filter(item => {
                const itemFrom = parseDate(item.fromDate);
                const itemTo = parseDate(item.toDate);
                
                // Check if date ranges overlap
                return (itemFrom <= to && itemTo >= from);
            });
        }

        // Parse date in dd/mm/yyyy format
        function parseDate(dateString) {
            // Handle different date formats
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            } else if (dateString.includes('-')) {
                return new Date(dateString);
            } else {
                // Try to parse as is
                return new Date(dateString);
            }
        }

        // Calculate months between two dates
        function calculateMonthsBetweenDates(fromDateStr, toDateStr) {
            const fromDate = parseDate(fromDateStr);
            const toDate = parseDate(toDateStr);
            
            let months = (toDate.getFullYear() - fromDate.getFullYear()) * 12;
            months += toDate.getMonth() - fromDate.getMonth();
            
            // Adjust for partial month
            if (toDate.getDate() < fromDate.getDate()) {
                months--;
            }
            
            return Math.max(months, 0);
        }

        // Clear DR table
        function clearDRTable() {
            const tableBody = document.getElementById('drTableBody');
            const tableFooter = document.getElementById('drTableFooter');
            
            tableBody.innerHTML = '';
            tableFooter.innerHTML = '';
            tableRows = [];
        }

        // Populate the DR table with editable fields
        function populateDRTable() {
            const tableBody = document.getElementById('drTableBody');
            const tableFooter = document.getElementById('drTableFooter');
            
            tableBody.innerHTML = '';
            tableRows = [];
            
            if (drData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="11" class="text-center">No DR details available for the selected date range</td>`;
                tableBody.appendChild(tr);
                tableFooter.innerHTML = '';
                return;
            }
            
            drData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Calculate months between from and to date
                const months = calculateMonthsBetweenDates(row.fromDate, row.toDate);
                
                // Due Details
                tr.innerHTML = `
                    <td><input type="text" class="editable-input" value="${row.fromDate}" data-field="fromDate" data-index="${index}"></td>
                    <td><input type="text" class="editable-input" value="${row.toDate}" data-field="toDate" data-index="${index}"></td>
                    <td><input type="number" class="editable-input" value="${row.dueBasicPension}" data-field="dueBasicPension" data-index="${index}"></td>
                    <td><input type="number" class="editable-input" value="${row.drDue}" data-field="drDue" data-index="${index}"></td>
                    <td><input type="number" class="editable-input amount-due" value="0" data-field="amountDue" data-index="${index}" ></td>
                    
                    <!-- Drawn Details -->
                    <td><input type="number" class="editable-input drawn-basic-pension" value="5000" data-field="drawnBasicPension" data-index="${index}"></td>
                    <td><input type="number" class="editable-input drawn-dr" value="1" data-field="drawnDR" data-index="${index}"></td>
                    <td><input type="number" class="editable-input amount-drawn" value="0" data-field="amountDrawn" data-index="${index}" ></td>
                    
                    <!-- Difference Details -->
                    <td><input type="number" class="editable-input difference" value="0" data-field="difference" data-index="${index}" readonly></td>
                    <td><input type="number" class="editable-input months" value="${months}" data-field="months" data-index="${index}" readonly></td>
                    <td><input type="number" class="editable-input gross-amount" value="0" data-field="grossAmount" data-index="${index}" readonly></td>
                `;
                
                tableBody.appendChild(tr);
                tableRows.push({
                    fromDate: row.fromDate,
                    toDate: row.toDate,
                    dueBasicPension: row.dueBasicPension,
                    drDue: row.drDue,
                    amountDue: 0,
                    drawnBasicPension: 5000,
                    drawnDR: 1,
                    amountDrawn: 0,
                    difference: 0,
                    months: months,
                    grossAmount: 0
                });
            });
            
            // Add event listeners to editable inputs
            document.querySelectorAll('.editable-input').forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const field = this.getAttribute('data-field');
                        const value = this.value;
                        
                        if (field === 'fromDate' || field === 'toDate') {
                            tableRows[index][field] = value;
                            // Recalculate months when dates change
                            const months = calculateMonthsBetweenDates(
                                tableRows[index].fromDate, 
                                tableRows[index].toDate
                            );
                            tableRows[index].months = months;
                            document.querySelector(`.months[data-index="${index}"]`).value = months;
                        } else {
                            tableRows[index][field] = parseFloat(value) || 0;
                        }
                    });
                }
            });
            
            // Add footer with grand total
            tableFooter.innerHTML = `
                <tr class="total-row">
                    <td colspan="10" class="text-end"><strong>Grand Total:</strong></td>
                    <td><strong id="grandTotal">0</strong></td>
                </tr>
            `;
        }

        // Calculate revision when Calculate button is clicked
        function calculateRevision() {
            const basicPension = parseFloat(document.getElementById('basicPension').value) || 0;
            const drawnDR = parseFloat(document.getElementById('drawnDR').value) || 0;
            
            let grandTotal = 0;
            
            tableRows.forEach((row, index) => {
                // Update drawn values from form if not manually edited
                if (!document.querySelector(`.drawn-basic-pension[data-index="${index}"]`).classList.contains('edited')) {
                    row.drawnBasicPension = basicPension;
                    document.querySelector(`.drawn-basic-pension[data-index="${index}"]`).value = basicPension;
                }
                
                if (!document.querySelector(`.drawn-dr[data-index="${index}"]`).classList.contains('edited')) {
                    row.drawnDR = drawnDR;
                    document.querySelector(`.drawn-dr[data-index="${index}"]`).value = drawnDR;
                }
                
                // Calculate amounts
                const amountDue = row.dueBasicPension + (row.dueBasicPension * row.drDue / 100);
                const amountDrawn = row.drawnBasicPension + (row.drawnBasicPension * row.drawnDR / 100);
                const difference = amountDue - amountDrawn;
                const grossAmount = difference * row.months;
                
                // Update table cells
                document.querySelector(`.amount-due[data-index="${index}"]`).value = Math.round(amountDue);
                document.querySelector(`.amount-drawn[data-index="${index}"]`).value = Math.round(amountDrawn);
                document.querySelector(`.difference[data-index="${index}"]`).value = Math.round(difference);
                document.querySelector(`.gross-amount[data-index="${index}"]`).value = Math.round(grossAmount);
                
                // Update data model
                tableRows[index].amountDue = Math.round(amountDue);
                tableRows[index].amountDrawn = Math.round(amountDrawn);
                tableRows[index].difference = Math.round(difference);
                tableRows[index].grossAmount = Math.round(grossAmount);
                
                grandTotal += Math.round(grossAmount);
            });
            
            // Update grand total (rounded up if necessary)
            document.getElementById('grandTotal').textContent = Math.ceil(grandTotal);
        }

        // Reset form to initial state
        function resetForm() {
            document.getElementById('treasury').value = '';
            document.getElementById('pensionerType').value = '';
            document.getElementById('pensionerCode').value = '';
            document.getElementById('pensionerName').value = '';
            document.getElementById('basicPension').value = '5000';
            document.getElementById('drawnDR').value = '1';
            initializeDates();
            clearDRTable();
            document.getElementById('drTableStatus').textContent = 'Please select a pensioner type to load DR data';
            document.getElementById('drTableStatus').className = 'alert alert-info';
            document.getElementById('drTable').style.display = 'none';
        }

        // Print calculation
        function printCalculation() {
            // Update print section with current data
            document.getElementById('printPensionerName').textContent = 
                document.getElementById('pensionerName').value.toUpperCase() || 'NOT PROVIDED';
            
            // Create pensioner code from all three parts
            const treasury = document.getElementById('treasury').value;
            const pensionerType = document.getElementById('pensionerType').value;
            const pensionerCode = document.getElementById('pensionerCode').value;
            const fullPensionerCode = `${treasury} / ${pensionerType} / ${pensionerCode}`;
            document.getElementById('printPensionerCode').textContent = fullPensionerCode || 'NOT PROVIDED';
            
            document.getElementById('printFromDate').textContent = 
                document.getElementById('fromDate').value || 'NOT PROVIDED';
            document.getElementById('printToDate').textContent = 
                document.getElementById('toDate').value || 'NOT PROVIDED';
            
            // Populate print table
            const printTableBody = document.getElementById('printTableBody');
            printTableBody.innerHTML = '';
            
            let grandTotal = 0;
            
            tableRows.forEach((row, index) => {
                const amountDue = row.dueBasicPension + (row.dueBasicPension * row.drDue / 100);
                const amountDrawn = row.drawnBasicPension + (row.drawnBasicPension * row.drawnDR / 100);
                const difference = amountDue - amountDrawn;
                const grossAmount = difference * row.months;
                
                grandTotal += Math.ceil(grossAmount);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.fromDate}</td>
                    <td>${row.toDate}</td>
                    <td>${row.dueBasicPension}</td>
                    <td>${row.drDue}%</td>
                    <td>${Math.round(amountDue)}</td>
                    <td>${row.drawnBasicPension}</td>
                    <td>${row.drawnDR}%</td>
                    <td>${Math.round(amountDrawn)}</td>
                    <td>${Math.round(difference)}</td>
                    <td>${row.months}</td>
                    <td>${Math.round(grossAmount)}</td>
                `;
                printTableBody.appendChild(tr);
            });
            
            // Add total row to print table
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="10" class="text-end"><strong>Grand Total:</strong></td>
                <td><strong>${Math.ceil(grandTotal)}</strong></td>
            `;
            printTableBody.appendChild(totalRow);
            
            // Show print section and trigger print
            document.getElementById('printSection').style.display = 'block';
            window.print();
            document.getElementById('printSection').style.display = 'none';
        }

        // Mark inputs as edited when manually changed
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('drawn-basic-pension') || 
                e.target.classList.contains('drawn-dr')) {
                e.target.classList.add('edited');
            }
        });
    </script>
</body>
</html>
