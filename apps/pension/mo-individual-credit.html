<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Order Pension Credit Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-top: 20px;
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .alert {
            border-radius: 10px;
            padding: 15px 20px;
        }
        
        .total-amount {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #e9ecef;
        }
        
        .filter-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .table-container {
            display: none;
        }
        
        /* DataTable customizations */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            border-radius: 8px;
            padding: 5px 10px;
            border: 1px solid #ddd;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 5px;
            margin: 0 2px;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #0d6efd;
            color: white !important;
            border: 1px solid #0d6efd;
        }
        
        .dt-buttons .btn {
            border-radius: 8px;
            margin-right: 5px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container" style="min-width:100%;">
        <div class="filter-section">
            <h3><i class="fas fa-file-invoice-dollar me-2"></i>Money Order Pension- Individual Credit Report</h3>
            <hr>
            <div class="row">
                <div class="col-md-2">
                    <div class="mb-2">
                        <label for="trCode" class="form-label">Treasury Code</label>
                        <input type="text" class="form-control" id="trCode" placeholder="Enter treasury code">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-2">
                        <label for="pensionType" class="form-label">Pension Type</label>
                        <input type="text" class="form-control" id="pensionType" placeholder="Pension type">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-2">
                        <label for="pensionCode" class="form-label">Code</label>
                        <input type="text" class="form-control" id="pensionCode" placeholder="Pension code">
                    </div>
                </div>
                <div class="col-md-2">
    <div class="mb-2">
        <label for="period" class="form-label">Month (MM/YYYY)</label>
        <input type="month" class="form-control" id="period">
    </div>
</div>
                <div class="col-md-2">
                    <div class="mb-2">
                        <label for="creditType" class="form-label">Credit Type</label>
                        <select class="form-select" id="creditType">
                            <option value="">All Credit Types</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    <button id="fetchData" class="btn btn-primary me-2" style="margin-top:30px;"><i class="fas fa-sync-alt me-2"></i>View</button>
                    <button id="clearFilters" class="btn btn-outline-secondary" style="margin-top:30px;"><i class="fas fa-times me-2"></i>Clear</button>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Fetching data ...</p>
        </div>
        
        <div class="alert alert-warning d-none" id="noDataAlert">
            <i class="fas fa-exclamation-triangle me-2"></i>No data found for the selected criteria.
        </div>
        
        <div class="table-container" id="tableContainer">
            <div class="card">
                <div class="card-body">
                    <div class="table-header">
                        <div class="table-title">Pension Credit Details</div>
                        <div class="total-amount" id="totalAmount">Total: 0.00</div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="pensionTable">
                            <thead>
                                <tr>
                                    <th>Sl.No</th>
                                    <th>Period</th>
                                    <th>Credit Type</th>
                                    <th>Treasury Code</th>
                                    <th>Pension Type</th>
                                    <th>Pensioner Code</th>
                                    <th>Remitter Reference</th>
                                    <th>Pensioner Name</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DataTables JavaScript -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

<script>
    // Configuration
    const API_KEY = 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4';
    const SPREADSHEET_ID = '1HOo8P4sAWp0N63Xfi8Fcna0zU2euo8_a5h3kSaOvJcI';
    const SHEET_NAME = 'IndividualDetails';
    const RANGE = 'A:F';
    
    // DOM Elements
    const trCodeInput = document.getElementById('trCode');
    const pensionTypeInput = document.getElementById('pensionType');
    const pensionCodeInput = document.getElementById('pensionCode');
    const periodInput = document.getElementById('period');
    const creditTypeSelect = document.getElementById('creditType');
    const fetchDataBtn = document.getElementById('fetchData');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noDataAlert = document.getElementById('noDataAlert');
    const dataTable = document.getElementById('dataTable');
    const totalAmountSpan = document.getElementById('totalAmount');
    const tableContainer = document.getElementById('tableContainer');
    
    // Global data storage
    let allData = [];
    let creditTypes = [];
    let dataTableInstance = null;
    
    // Initialize the application - Load credit types on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load credit types when page initializes
        setCurrentMonth();
        loadCreditTypes();
        
        // Add event listeners
        fetchDataBtn.addEventListener('click', fetchDataFromSheet);
        clearFiltersBtn.addEventListener('click', clearFilters);
    });
    
    // Load credit types from Google Sheets
    async function loadCreditTypes() {
        showLoading(true);
        
        try {
            // Construct the URL for the Google Sheets API
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE}?key=${API_KEY}`;
            
            // Fetch data from Google Sheets
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.values && data.values.length > 0) {
                // Process the data to extract credit types
                const rawData = data.values;
                const dataRows = rawData.slice(1); // Skip header row
                
                // Extract unique credit types from column F (index 5)
                const types = new Set();
                dataRows.forEach(row => {
                    const creditType = row[5] || ''; // Column F is index 5
                    if (creditType && creditType.trim() !== '') {
                        types.add(creditType.trim());
                    }
                });
                
                creditTypes = Array.from(types).sort();
                
                // Populate credit type dropdown
                populateCreditTypeDropdown();
            } else {
                throw new Error('No data found in the sheet');
            }
        } catch (error) {
            console.error('Error loading credit types:', error);
            showError('Failed to load credit types. Please check the console for details.');
        } finally {
            showLoading(false);
        }
    }
    
    // Fetch data from Google Sheets
    async function fetchDataFromSheet() {
        showLoading(true);
        noDataAlert.classList.add('d-none');
        tableContainer.style.display = 'none';
        
        // Clear existing DataTable instance if it exists
        if (dataTableInstance) {
            dataTableInstance.destroy();
            dataTableInstance = null;
        }
        // Clear the table body
        dataTable.innerHTML = '';
        
        try {
            // Construct the URL for the Google Sheets API
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE}?key=${API_KEY}`;
            
            // Fetch data from Google Sheets
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.values && data.values.length > 0) {
                // Process the data (skip header row)
                allData = processSheetData(data.values);
                
                // Apply filters and display data
                applyFiltersAndDisplay();
            } else {
                throw new Error('No data found in the sheet');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showError('Failed to fetch data. Please check the console for details.');
        } finally {
            showLoading(false);
        }
    }
    
    // Process the raw data from Google Sheets
    function processSheetData(rawData) {
        // Skip the header row (index 0)
        const dataRows = rawData.slice(1);
        
        return dataRows.map((row, index) => {
            // Extract remitter reference components
            const remitterRef = row[3] || '';
            const trCodeMatch = remitterRef.match(/Trcode:(\d+)/);
            const pensionCodeMatch = remitterRef.match(/Pension Code:([\d\/]+)/);
            
            // Extract pension type and code from the remitter reference
            let pensionType = '';
            let pensionCode = '';
            let pensionerCode = '';
            
            if (pensionCodeMatch) {
                const pensionParts = pensionCodeMatch[1].split('/');
                if (pensionParts.length > 1) {
                    pensionType = pensionParts[0];
                    pensionerCode = pensionParts[1];
                } else {
                    pensionerCode = pensionParts[0];
                }
            }
            
            return {
                amount: parseFloat(row[0]) || 0,
                pensionerName: row[1] || '',
                trackCode: row[2] || '',
                remitterReference: remitterRef,
                trCode: trCodeMatch ? trCodeMatch[1] : '',
                pensionType: pensionType,
                pensionerCode: pensionerCode,
                period: row[4] || '',
                creditType: row[5] || '',
                // Add sortable date for period
                sortableDate: convertPeriodToDate(row[4] || '')
            };
        });
    }
    
    // Convert period string (MM/YYYY) to Date object for sorting
    function convertPeriodToDate(period) {
        if (!period || !period.includes('/')) return new Date(0);
        
        const [month, year] = period.split('/');
        return new Date(parseInt(year), parseInt(month) - 1, 1);
    }
    
    // Populate the credit type dropdown
    function populateCreditTypeDropdown() {
        // Clear existing options except the first one
        while (creditTypeSelect.options.length > 1) {
            creditTypeSelect.remove(1);
        }
        
        // Add credit types to dropdown
        creditTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            creditTypeSelect.appendChild(option);
        });
    }
    
    // Apply filters and display the data
    function applyFiltersAndDisplay() {
        const trCodeFilter = trCodeInput.value.trim();
    const pensionTypeFilter = pensionTypeInput.value.trim();
    const pensionCodeFilter = pensionCodeInput.value.trim();
    const periodFilter = formatMonthInputValue(periodInput.value);
    const creditTypeFilter = creditTypeSelect.value;
        
        // Filter the data based on user inputs with STRICT matching
        let filteredData = allData;
        
        if (trCodeFilter) {
            filteredData = filteredData.filter(item => 
                item.trCode === trCodeFilter
            );
        }
        
        if (pensionTypeFilter) {
            filteredData = filteredData.filter(item => 
                item.pensionType === pensionTypeFilter
            );
        }
        
        if (pensionCodeFilter) {
            filteredData = filteredData.filter(item => 
                item.pensionerCode === pensionCodeFilter
            );
        }
        
        if (periodFilter) {
            filteredData = filteredData.filter(item => 
                item.period === periodFilter
            );
        }
        
        if (creditTypeFilter) {
            filteredData = filteredData.filter(item => 
                item.creditType === creditTypeFilter
            );
        }
        
        // Sort by period in descending order (newest first)
        filteredData.sort((a, b) => b.sortableDate - a.sortableDate);
        
        // Display the filtered data
        displayData(filteredData);
    }
    
    // Display data in the table
    function displayData(data) {
        // Clear the table
        dataTable.innerHTML = '';
        
        if (data.length === 0) {
            noDataAlert.classList.remove('d-none');
            totalAmountSpan.textContent = 'Total: 0.00';
            tableContainer.style.display = 'none';
            return;
        }
        
        // Calculate total amount
        const totalAmount = data.reduce((sum, item) => sum + item.amount, 0);
        totalAmountSpan.textContent = `Total: ${totalAmount.toFixed(2)}`;
        
        // Populate the table with serial numbers
        data.forEach((item, index) => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.period}</td>
                <td>${item.creditType}</td>
                <td>${item.trCode}</td>
                <td>${item.pensionType}</td>
                <td>${item.pensionerCode}</td>
                <td>${item.remitterReference}</td>
                <td>${item.pensionerName}</td>
                <td>${item.amount.toFixed(2)}</td>
            `;
            
            dataTable.appendChild(row);
        });
        
        // Initialize or reinitialize DataTable
        initializeDataTable();
        
        // Show the table
        tableContainer.style.display = 'block';
    }
    
    // Initialize DataTable with search, pagination, and export options
    function initializeDataTable() {
        // Destroy existing DataTable instance if it exists
        if (dataTableInstance) {
            dataTableInstance.destroy();
            dataTableInstance = null;
        }
        
        // Initialize DataTable
        dataTableInstance = $('#pensionTable').DataTable({
            dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            buttons: [
                {
                    extend: 'copy',
                    className: 'btn btn-secondary',
                    text: '<i class="fas fa-copy me-1"></i>Copy'
                },
                {
                    extend: 'excel',
                    className: 'btn btn-success',
                    text: '<i class="fas fa-file-excel me-1"></i>Excel'
                },
                {
                    extend: 'pdf',
                    className: 'btn btn-danger',
                    text: '<i class="fas fa-file-pdf me-1"></i>PDF'
                },
                {
                    extend: 'print',
                    className: 'btn btn-info',
                    text: '<i class="fas fa-print me-1"></i>Print'
                },
                {
                    extend: 'colvis',
                    className: 'btn btn-warning',
                    text: '<i class="fas fa-columns me-1"></i>Columns'
                }
            ],
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            order: [[0, 'asc']],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                infoEmpty: "Showing 0 to 0 of 0 entries",
                infoFiltered: "(filtered from _MAX_ total entries)",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            responsive: true,
            destroy: true // This ensures the table is completely destroyed before reinitialization
        });
    }
    
    // Clear all filters
    function clearFilters() {
        trCodeInput.value = '';
    pensionTypeInput.value = '';
    pensionCodeInput.value = '';
    setCurrentMonth(); // Reset to current month
    creditTypeSelect.value = '';
        
        // Clear the table and hide container
        dataTable.innerHTML = '';
        tableContainer.style.display = 'none';
        noDataAlert.classList.add('d-none');
        setCurrentMonth();
        
        // Destroy existing DataTable instance if it exists
        if (dataTableInstance) {
            dataTableInstance.destroy();
            dataTableInstance = null;
        }
    }
    
    // Show/hide loading indicator
    function showLoading(show) {
        loadingIndicator.style.display = show ? 'block' : 'none';
    }
    
    // Show error message
    function showError(message) {
        noDataAlert.textContent = message;
        noDataAlert.classList.remove('d-none');
    }
    
    // Set current month in MM/YYYY format
   function setCurrentMonth() {
    const currentDate = new Date();
    const currentMonth = String(currentDate.getMonth() + 1); // Without padding
    const currentYear = currentDate.getFullYear();
    periodInput.value = `${currentYear}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
}
    function formatMonthInputValue(monthValue) {
    if (!monthValue) return '';
    
    // monthValue comes as "YYYY-MM" from input type="month"
    const [year, month] = monthValue.split('-');
    return `${parseInt(month, 10)}/${year}`; // Remove leading zero from month
}
</script>
</body>
</html>
