<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Revision Calculator</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: .2rem 0;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: .6rem .6rem 2rem;
            font-weight: 400;
        }
        .fw-bold {
         font-weight: 400 !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
           
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-success:hover {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .calculation-period {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .table thead {
            background: linear-gradient(to right, var(--secondary-color), var(--secondary-color));
            color: white;
        }
        
        .table tbody tr:nth-child(even) {
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .total-row {
            font-weight: bold;
            background-color: rgba(52, 152, 219, 0.2) !important;
        }
        
        .icon-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 1.5rem 0;
            margin-top: 2rem;
            border-radius: 20px 20px 0 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            color: #777;
        }
        
        .step.active .step-number {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
        }
        
        .step-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #777;
        }
        
        .step.active .step-label {
            color: var(--primary-color);
        }
        
        .editable-input {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            background-color: white;
			max-width:6.6rem;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .print-only {
            display: none;
        }
        
        .flatpickr-input {
            background-color: white;
            cursor: text !important;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .dr-due-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dr-due-input {
            /*width: 50% !important;*/
			max-width:60px;
        }
        .drawn-dr {
        /* width: 50% !important; */
         max-width: 60px;
         }
		 .amount-due{
		 font-weight: 600;
         color: red;
		 }
		 .amount-drawn{
		 font-weight: 600;
         color: blue;
		 }
		 .gross-amount{
		  font-weight: 600;
		 }
        .revision-label {
            font-size: 0.8rem;
            color: #6c757d;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
			min-width: 70px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            .table {
                border: 1px solid #000;
            }
            .table th, .table td {
                border: 1px solid #000;
            }
        }
        
        @media (max-width: 768px) {
            .step-label {
                font-size: 0.8rem;
            }
        }
        .table>:not(caption)>*>* {
            padding: .2rem .2rem;
            background-color: var(--bs-table-bg);
            border-bottom-width: var(--bs-border-width);
            box-shadow: inset 0 0 0 9999px var(--bs-table-accent-bg);
        }
    </style>
</head>
<body>
    <div class="header no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold"><i class="bi bi-calculator-fill"></i> Core Pension Revision Calculator</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="container no-print" style="min-width: 100%;">
        <!-- Calculation Period Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="icon-container">
                        <i class="bi bi-calendar-range"></i>
                    </div>
                    <h5 class="mb-0">Calculation Period</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="fromDate" class="form-label">From</label>
                        <input type="text" class="form-control flatpickr-input" id="fromDate" placeholder="Select From Date">
                    </div>
                    <div class="col-md-2">
                        <label for="toDate" class="form-label">To</label>
                        <input type="text" class="form-control flatpickr-input" id="toDate" placeholder="Select To Date">
                    </div>
					  <div class="col-md-2">
                            <label class="form-label">Years</label>
                            <input type="text" class="form-control" id="years" readOnly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Months</label>
                            <input type="text" class="form-control" id="months" readOnly >
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Days</label>
                            <input type="text" class="form-control" id="days" readonly>
                        </div>
                </div>
                <!--
                <div class="calculation-period mt-4">
                    <div class="row">
                      
                    </div>
                </div>-->
            </div>
        </div>

        <!-- Pensioner Details Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="icon-container">
                        <i class="bi bi-person-vcard"></i>
                    </div>
                    <h5 class="mb-0">Pensioner Details</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="treasury" class="form-label">Treasury</label>
                        <select class="form-select" id="treasury">
                            <option value="">Loading treasuries...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="pensionerType" class="form-label">Pensioner Type</label>
                        <select class="form-select" id="pensionerType">
                            <option value="">Loading pension types...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="pensionerCode" class="form-label">Pensioner Code</label>
                        <input type="text" class="form-control" id="pensionerCode" placeholder="Enter pensioner code">
                    </div>
                    <div class="col-md-4">
                        <label for="pensionerName" class="form-label">Pensioner Name</label>
                        <input type="text" class="form-control" id="pensionerName" placeholder="Enter pensioner name">
                    </div>
                    <div class="col-md-2">
                        <label for="basicPensionDrawn" class="form-label">Basic Pension Drawn</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="basicPensionDrawn" placeholder="" value="">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="drawnDR" class="form-label">DR% Drawn</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="drawnDR" placeholder="" value="">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="basicPensionDue" class="form-label">Basic Pension Due</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="basicPensionDue" placeholder="" value="">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label for="revisionNoFrom" class="form-label">Revision No From</label>
                        <select class="form-select" id="revisionNoFrom">
                            <option value="">Select Revision No</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label for="revisionNoTo" class="form-label"> To</label>
                        <select class="form-select" id="revisionNoTo">
                            <option value="">Select Revision No</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- DR Table Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="icon-container">
                        <i class="bi bi-table"></i>
                    </div>
                    <h5 class="mb-0">Calculation Table</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info" id="drTableStatus">
                    Please fill all details and click Calculate to generate the table.
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="drTable" style="display: none;">
                        <thead>
                            <tr>
                                <th colspan="4" class="text-center">Due Details</th>
                                <th colspan="4" class="text-center">Drawn Details</th>
                                <th colspan="2" class="text-center">Difference Details</th>
                                <th colspan="2">Actions</th>
                            </tr>
                            <tr>
                                <th>From Date</th>
                                <th>To Date</th>
                                <th>Basic Pension (Due)</th>
                                <th>DR% - Due</th>
                                <th>Amount Due</th>
                                <th>Basic Pension (Drawn)</th>
                                <th>DR% Drawn</th>
                                <th>Amount Drawn</th>
                                <th>Difference</th>
                                <th>No. of Months</th>
                                <th>Gross Amount</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="drTableBody" style="font-size: 12px;">
                            <!-- Table rows will be generated dynamically -->
                        </tbody>
                        <tfoot id="drTableFooter">
                            <!-- Footer with grand total will be generated dynamically -->
                        </tfoot>
                    </table>
                    <div class="text-center mt-3" id="addRowSection" style="display: none;">
                        <button class="btn btn-success btn-sm" id="addRowBtn">
                            <i class="bi bi-plus-circle"></i> Add New Row
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mb-5">
            <button class="btn btn-outline-secondary" id="resetBtn">
                <i class="bi bi-arrow-clockwise"></i> Reset 
            </button>
            <div>
                <button class="btn btn-primary me-2" id="calculateBtn">
                    <i class="bi bi-calculator"></i> Calculate
                </button>
                <button class="btn btn-danger" id="printBtn">
                    <i class="bi bi-printer"></i> Print 
                </button>
            </div>
        </div>
    </div>

    <!-- Print Section -->
    <div class="print-section" id="printSection" style="display: none;">
        <div class="container">
            <div class="text-center mb-4">
                <h1 class="print-only">Pension Revision</h1>
                <div class="row mt-4">
                    <div class="col-md-6 text-start">
                        <p><strong>Name of Pensioner:</strong> <span id="printPensionerName"></span></p>
                    </div>
                    <div class="col-md-6 text-start">
                        <p><strong>Pensioner Code:</strong> <span id="printPensionerCode"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-start">
                        <p><strong>Calculation Period:</strong> From <span id="printFromDate"></span> To <span id="printToDate"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th colspan="4" class="text-center">Due Details</th>
                            <th colspan="4" class="text-center">Drawn Details</th>
                            <th colspan="4" class="text-center">Difference Details</th>
                        </tr>
                        <tr>
                            <th>From Date</th>
                            <th>To Date</th>
                            <th>Basic Pension(Due)</th>
                            <th>DR% - Due</th>
                            <th>Amount Due</th>
                            <th>Basic Pension(Drawn)</th>
                            <th>DR% Drawn</th>
                            <th>Amount Drawn</th>
                            <th>Difference</th>
                            <th>No. of Months</th>
                            <th>Gross Amount</th>
                        </tr>
                    </thead>
                    <tbody id="printTableBody">
                        <!-- Print table rows will be generated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Global variables
        let drData = [];
        let tableRows = [];
        let settingsData = {
            treasuries: [],
            pensionerTypes: []
        };

        // Google Sheets configuration
        const SHEET_ID = "11oRitOvxaUmQIP6cAFBBTBXMnSV_ZIw6DD9aL_RpILc";
        const API_KEY = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize flatpickr for date inputs
            flatpickr("#fromDate", {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                defaultDate: new Date(new Date().getFullYear() - 1, new Date().getMonth(), 1)
            });
            
            flatpickr("#toDate", {
                altInput: true,
                altFormat: "d/m/Y",
                dateFormat: "Y-m-d",
                defaultDate: new Date()
            });
            
            // Initialize date inputs and calculate period
            initializeDates();
            
            // Set up event listeners
            document.getElementById('fromDate').addEventListener('change', calculatePeriod);
            document.getElementById('toDate').addEventListener('change', calculatePeriod);
            document.getElementById('calculateBtn').addEventListener('click', calculateRevision);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('printBtn').addEventListener('click', printCalculation);
            document.getElementById('pensionerType').addEventListener('change', fetchDRData);
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);
            
            // Fetch settings data from Google Sheets
            fetchSettingsData();
        });

        // Initialize dates for calculation period
        function initializeDates() {
            // Calculate initial period
            calculatePeriod();
        }

        // Calculate period when dates change
        function calculatePeriod() {
            const fromDateInput = document.getElementById('fromDate');
            const toDateInput = document.getElementById('toDate');
            const yearsInput = document.getElementById('years');
            const monthsInput = document.getElementById('months');
            const daysInput = document.getElementById('days');
            
            const fromDate = new Date(fromDateInput.value);
            const toDate = new Date(toDateInput.value);
            
            if (fromDate && toDate && fromDate <= toDate) {
                let years = toDate.getFullYear() - fromDate.getFullYear();
                let months = toDate.getMonth() - fromDate.getMonth();
                let days = toDate.getDate() - fromDate.getDate();
                
                if (days < 0) {
                    months--;
                    // Get days in the previous month
                    const prevMonth = new Date(toDate.getFullYear(), toDate.getMonth(), 0);
                    days += prevMonth.getDate();
                }
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                yearsInput.value = years;
                monthsInput.value = months;
                daysInput.value = days;
            }
        }

        // Fetch settings data from Google Sheets
        async function fetchSettingsData() {
            try {
                showLoadingState(true);
                
                // Fetch data from Settings sheet - Column A (Treasuries)
                const treasuryResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Settings!A2:A?key=${API_KEY}`);
                const treasuryData = await treasuryResponse.json();
                
                // Fetch data from Settings sheet - Column B (Pensioner Types)
                const pensionTypeResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Settings!B2:B?key=${API_KEY}`);
                const pensionTypeData = await pensionTypeResponse.json();
                
                // Process the data
                settingsData.treasuries = treasuryData.values ? treasuryData.values.flat().filter(val => val.trim() !== '') : [];
                settingsData.pensionerTypes = pensionTypeData.values ? pensionTypeData.values.flat().filter(val => val.trim() !== '') : [];
                
                // Populate the dropdowns
                populateSettingsDropdowns();
                showLoadingState(false);
                
            } catch (error) {
                console.error('Error fetching settings data:', error);
                document.getElementById('treasury').innerHTML = '<option value="">Error loading treasuries</option>';
                document.getElementById('pensionerType').innerHTML = '<option value="">Error loading pension types</option>';
                showLoadingState(false);
            }
        }

        // Show/hide loading state
        function showLoadingState(isLoading) {
            const treasurySelect = document.getElementById('treasury');
            const pensionTypeSelect = document.getElementById('pensionerType');
            
            if (isLoading) {
                treasurySelect.innerHTML = '<option value="">Loading treasuries...</option>';
                pensionTypeSelect.innerHTML = '<option value="">Loading pension types...</option>';
                treasurySelect.disabled = true;
                pensionTypeSelect.disabled = true;
            } else {
                treasurySelect.disabled = false;
                pensionTypeSelect.disabled = false;
            }
        }

        // Populate settings dropdowns
        function populateSettingsDropdowns() {
            const treasurySelect = document.getElementById('treasury');
            const pensionerTypeSelect = document.getElementById('pensionerType');
            
            // Clear existing options
            treasurySelect.innerHTML = '<option value="">Select Treasury</option>';
            pensionerTypeSelect.innerHTML = '<option value="">Select Pensioner Type</option>';
            
            // Add treasury options
            settingsData.treasuries.forEach(treasury => {
                const option = document.createElement('option');
                option.value = treasury;
                option.textContent = treasury;
                treasurySelect.appendChild(option);
            });
            
            // Add pensioner type options
            settingsData.pensionerTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                pensionerTypeSelect.appendChild(option);
            });
        }

        // Fetch DR data from Google Sheets based on selected pensioner type
        async function fetchDRData() {
            const pensionerType = document.getElementById('pensionerType').value;
            
            if (!pensionerType) {
                document.getElementById('drTableStatus').textContent = 'Please select a pensioner type to load DR data';
                document.getElementById('drTableStatus').className = 'alert alert-info';
                document.getElementById('drTable').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('drTableStatus').textContent = 'Loading DR data...';
                document.getElementById('drTableStatus').className = 'alert alert-warning';
                
                // Fetch DR data from the sheet named after the pensioner type (columns C:F)
                const drResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${pensionerType}!C2:F?key=${API_KEY}`);
                const drDataResponse = await drResponse.json();
                
                if (!drDataResponse.values || drDataResponse.values.length === 0) {
                    document.getElementById('drTableStatus').textContent = 'No DR data available for selected pension type';
                    document.getElementById('drTableStatus').className = 'alert alert-warning';
                    document.getElementById('drTable').style.display = 'none';
                    drData = [];
                    return;
                }
                
                // Process DR data (columns C:F: From Date, To Date, Revision No, DR%)
                drData = drDataResponse.values.map(row => ({
                    fromDate: row[0] || '',
                    toDate: row[1] || '',
                    revisionNo: row[2] || '',
                    drDue: parseFloat(row[3] ? row[3].replace('%', '') : 0) || 0
                })).filter(item => item.fromDate && item.toDate);
                
                // Populate Revision No dropdowns
                populateRevisionNoDropdowns();
                
                document.getElementById('drTableStatus').textContent = `DR data loaded for ${pensionerType}. Click Calculate to generate table.`;
                document.getElementById('drTableStatus').className = 'alert alert-success';
                
            } catch (error) {
                console.error('Error fetching DR data:', error);
                document.getElementById('drTableStatus').textContent = 'Error loading DR data. Please try again.';
                document.getElementById('drTableStatus').className = 'alert alert-danger';
                document.getElementById('drTable').style.display = 'none';
                drData = [];
            }
        }

        // Populate Revision No dropdowns
        function populateRevisionNoDropdowns() {
            const revisionNoFrom = document.getElementById('revisionNoFrom');
            const revisionNoTo = document.getElementById('revisionNoTo');
            
            // Clear existing options
            revisionNoFrom.innerHTML = '<option value="">Select Revision No</option>';
            revisionNoTo.innerHTML = '<option value="">Select Revision No</option>';
            
            // Get unique revision numbers
            const revisionNos = [...new Set(drData.map(item => item.revisionNo))].filter(val => val);
            
            // Add revision number options
            revisionNos.forEach(revNo => {
                const optionFrom = document.createElement('option');
                optionFrom.value = revNo;
                optionFrom.textContent = revNo;
                revisionNoFrom.appendChild(optionFrom);
                
                const optionTo = document.createElement('option');
                optionTo.value = revNo;
                optionTo.textContent = revNo;
                revisionNoTo.appendChild(optionTo);
            });
        }

        // Parse date in dd/mm/yyyy format
        function parseDate(dateString) {
            // Handle different date formats
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            } else if (dateString.includes('-')) {
                return new Date(dateString);
            } else {
                // Try to parse as is
                return new Date(dateString);
            }
        }

        // Format date to DD/MM/YYYY for display in table
        function formatDateToDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Calculate months between two dates (fixed to show actual months)
        function calculateMonthsBetweenDates(fromDateStr, toDateStr) {
            const fromDate = parseDate(fromDateStr);
            const toDate = parseDate(toDateStr);
            
            let months = (toDate.getFullYear() - fromDate.getFullYear()) * 12;
            months += toDate.getMonth() - fromDate.getMonth();
            
            // Include the current month if we're counting full months
            if (toDate.getDate() >= fromDate.getDate()) {
                months += 1;
            }
            
            return Math.max(months, 1); // Minimum 1 month
        }

        // Clear DR table
        function clearDRTable() {
            const tableBody = document.getElementById('drTableBody');
            const tableFooter = document.getElementById('drTableFooter');
            
            tableBody.innerHTML = '';
            tableFooter.innerHTML = '';
            tableRows = [];
            document.getElementById('addRowSection').style.display = 'none';
        }

        // Get DR% Due by date range and revision number
        function getDRDueByDateRangeAndRevision(fromDate, toDate, revisionNo) {
            const from = parseDate(fromDate);
            const to = parseDate(toDate);
            
            // Find DR data that matches the date range AND revision number
            const matchingRecord = drData.find(item => {
                const itemFrom = parseDate(item.fromDate);
                const itemTo = parseDate(item.toDate);
                const itemRevisionNo = item.revisionNo;
                
                // Check if the date ranges overlap AND revision number matches
                return ((from >= itemFrom && from <= itemTo) || 
                       (to >= itemFrom && to <= itemTo) ||
                       (itemFrom >= from && itemFrom <= to)) &&
                       itemRevisionNo === revisionNo;
            });
            
            return matchingRecord ? matchingRecord.drDue : 0;
        }

        // Round amount based on decimal value
        function roundAmount(amount) {
            const decimal = amount - Math.floor(amount);
            if (decimal >= 0.5) {
                return Math.ceil(amount);
            } else {
                return Math.floor(amount);
            }
        }

        // Remove row from table
        function removeRow(index) {
            tableRows.splice(index, 1);
            renderTable();
            updateGrandTotal();
        }

        // Add new row to table
        function addNewRow() {
            const basicPensionDue = parseFloat(document.getElementById('basicPensionDue').value) || 0;
            const basicPensionDrawn = parseFloat(document.getElementById('basicPensionDrawn').value) || 0;
            const drawnDR = parseFloat(document.getElementById('drawnDR').value) || 0;
            const revisionNoFrom = document.getElementById('revisionNoFrom').value;
            
            // Get the last row's to date or use current date
            let lastToDate = new Date();
            if (tableRows.length > 0) {
                lastToDate = new Date(parseDate(tableRows[tableRows.length - 1].toDate));
                lastToDate.setDate(lastToDate.getDate() + 1);
            }
            
            const newFromDate = formatDateToDDMMYYYY(lastToDate);
            const newToDate = formatDateToDDMMYYYY(new Date(lastToDate.getFullYear(), lastToDate.getMonth() + 1, lastToDate.getDate()));
            
            const months = calculateMonthsBetweenDates(newFromDate, newToDate);
            
            // Get DR% Due based on revision number
            const drDue = getDRDueByDateRangeAndRevision(newFromDate, newToDate, revisionNoFrom);
            
            const newRow = {
                fromDate: newFromDate,
                toDate: newToDate,
                dueBasicPension: basicPensionDue,
                drDue: drDue,
                amountDue: 0,
                drawnBasicPension: basicPensionDrawn,
                drawnDR: drawnDR,
                amountDrawn: 0,
                difference: 0,
                months: months,
                grossAmount: 0,
                revisionNo: revisionNoFrom
            };
            
            tableRows.push(newRow);
            renderTable();
        }

        // Render table with current data
        function renderTable() {
            const tableBody = document.getElementById('drTableBody');
            tableBody.innerHTML = '';
            
            tableRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // All fields are editable
                tr.innerHTML = `
                    <td><input type="text" class="editable-input" value="${row.fromDate}" data-field="fromDate" data-index="${index}"></td>
                    <td><input type="text" class="editable-input" value="${row.toDate}" data-field="toDate" data-index="${index}"></td>
                    <td><input type="number" class="editable-input" value="${row.dueBasicPension}" data-field="dueBasicPension" data-index="${index}"></td>
                    <td>
                        <div class="dr-due-container">
                            <input type="number" class="editable-input dr-due-input" value="${row.drDue}" data-field="drDue" data-index="${index}">
                            <span class="revision-label">Rev no.${row.revisionNo || 'N/A'}</span>
                        </div>
                    </td>
                    <td><input type="number" class="editable-input amount-due" value="${row.amountDue}" data-field="amountDue" data-index="${index}" readonly></td>
                    
                    <!-- Drawn Details -->
                    <td><input type="number" class="editable-input drawn-basic-pension" value="${row.drawnBasicPension}" data-field="drawnBasicPension" data-index="${index}"></td>
                    <td><input type="number" class="editable-input drawn-dr" value="${row.drawnDR}" data-field="drawnDR" data-index="${index}"></td>
                    <td><input type="number" class="editable-input amount-drawn" value="${row.amountDrawn}" data-field="amountDrawn" data-index="${index}" readonly></td>
                    
                    <!-- Difference Details -->
                    <td><input type="number" class="editable-input difference" value="${row.difference}" data-field="difference" data-index="${index}" readonly></td>
                    <td><input type="number" class="editable-input months" value="${row.months}" data-field="months" data-index="${index}" readonly></td>
                    <td><input type="number" class="editable-input gross-amount" value="${row.grossAmount}" data-field="grossAmount" data-index="${index}" readonly></td>
                    
                    <!-- Action Buttons -->
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-sm remove-row" data-index="${index}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            // Add event listeners to editable inputs and remove buttons
            addEventListenersToTable();
        }

        // Add event listeners to table elements
        function addEventListenersToTable() {
            // Editable inputs
            document.querySelectorAll('.editable-input').forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const field = this.getAttribute('data-field');
                        const value = this.value;
                        
                        if (field === 'fromDate' || field === 'toDate') {
                            tableRows[index][field] = value;
                            // Recalculate months when dates change
                            const months = calculateMonthsBetweenDates(
                                tableRows[index].fromDate, 
                                tableRows[index].toDate
                            );
                            tableRows[index].months = months;
                            document.querySelector(`.months[data-index="${index}"]`).value = months;
                            
                            // Recalculate amounts
                            recalculateRowAmounts(index);
                        } else {
                            tableRows[index][field] = parseFloat(value) || 0;
                            // Recalculate amounts if pension or DR values change
                            if (field === 'dueBasicPension' || field === 'drDue' || 
                                field === 'drawnBasicPension' || field === 'drawnDR') {
                                recalculateRowAmounts(index);
                            }
                        }
                        
                        // Recalculate grand total
                        updateGrandTotal();
                    });
                }
            });
            
            // Remove buttons
            document.querySelectorAll('.remove-row').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeRow(index);
                });
            });
        }

        // Recalculate amounts for a specific row
        function recalculateRowAmounts(index) {
            const row = tableRows[index];
            
            // Calculate amounts with proper rounding
            const amountDue = row.dueBasicPension + (row.dueBasicPension * row.drDue / 100);
            const amountDrawn = row.drawnBasicPension + (row.drawnBasicPension * row.drawnDR / 100);
            const difference = amountDue - amountDrawn;
            const grossAmount = difference * row.months;
            
            // Update row data with rounded values
            row.amountDue = roundAmount(amountDue);
            row.amountDrawn = roundAmount(amountDrawn);
            row.difference = roundAmount(difference);
            row.grossAmount = roundAmount(grossAmount);
            
            // Update table cells
            document.querySelector(`.amount-due[data-index="${index}"]`).value = row.amountDue;
            document.querySelector(`.amount-drawn[data-index="${index}"]`).value = row.amountDrawn;
            document.querySelector(`.difference[data-index="${index}"]`).value = row.difference;
            document.querySelector(`.gross-amount[data-index="${index}"]`).value = row.grossAmount;
        }

        // Calculate revision when Calculate button is clicked
        function calculateRevision() {
            // Validate required fields
            const pensionerType = document.getElementById('pensionerType').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const basicPensionDue = parseFloat(document.getElementById('basicPensionDue').value) || 0;
            const revisionNoFrom = document.getElementById('revisionNoFrom').value;
            
            if (!pensionerType || !fromDate || !toDate || !revisionNoFrom) {
                document.getElementById('drTableStatus').textContent = 'Please fill all required fields: Pensioner Type, From Date, To Date, and Revision No From';
                document.getElementById('drTableStatus').className = 'alert alert-warning';
                return;
            }
            
            if (drData.length === 0) {
                document.getElementById('drTableStatus').textContent = 'No DR data available. Please select a valid pensioner type.';
                document.getElementById('drTableStatus').className = 'alert alert-warning';
                return;
            }
            
            try {
                document.getElementById('drTableStatus').textContent = 'Calculating...';
                document.getElementById('drTableStatus').className = 'alert alert-warning';
                
                // Clear previous table
                clearDRTable();
                
                const tableBody = document.getElementById('drTableBody');
                const tableFooter = document.getElementById('drTableFooter');
                tableRows = [];
                
                // Get user inputs
                const basicPensionDrawn = parseFloat(document.getElementById('basicPensionDrawn').value) || 0;
                const drawnDR = parseFloat(document.getElementById('drawnDR').value) || 0;
                const userFromDate = new Date(fromDate);
                const userToDate = new Date(toDate);
                
                // Filter DR data for the selected date range AND revision number
                const filteredDRData = drData.filter(item => {
                    const itemFrom = parseDate(item.fromDate);
                    const itemTo = parseDate(item.toDate);
                    
                    // Check if date ranges overlap AND revision number matches
                    return (itemFrom <= userToDate && itemTo >= userFromDate) && 
                           item.revisionNo === revisionNoFrom;
                });
                
                if (filteredDRData.length === 0) {
                    document.getElementById('drTableStatus').textContent = 'No DR data available for the selected date range and revision number';
                    document.getElementById('drTableStatus').className = 'alert alert-warning';
                    return;
                }
                
                // Sort by from date
                filteredDRData.sort((a, b) => parseDate(a.fromDate) - parseDate(b.fromDate));
                
                // Create calculation periods
                const calculationPeriods = [];
                
                for (let i = 0; i < filteredDRData.length; i++) {
                    const currentRow = filteredDRData[i];
                    let periodFromDate, periodToDate;
                    
                    if (i === 0) {
                        // First period starts from user's from date
                        periodFromDate = formatDateToDDMMYYYY(userFromDate);
                    } else {
                        // Subsequent periods start from day after previous to date
                        const prevToDate = new Date(parseDate(calculationPeriods[i-1].toDate));
                        prevToDate.setDate(prevToDate.getDate() + 1);
                        periodFromDate = formatDateToDDMMYYYY(prevToDate);
                    }
                    
                    // Period ends at the earlier of: DR data's to date or user's to date
                    const drToDate = parseDate(currentRow.toDate);
                    const periodToDateObj = drToDate < userToDate ? drToDate : userToDate;
                    periodToDate = formatDateToDDMMYYYY(periodToDateObj);
                    
                    // Ensure from date is not after to date
                    if (parseDate(periodFromDate) > parseDate(periodToDate)) {
                        periodFromDate = periodToDate;
                    }
                    
                    calculationPeriods.push({
                        fromDate: periodFromDate,
                        toDate: periodToDate,
                        dueBasicPension: basicPensionDue,
                        drDue: currentRow.drDue,
                        revisionNo: currentRow.revisionNo
                    });
                    
                    // Stop if we've reached user's to date
                    if (periodToDateObj.getTime() === userToDate.getTime()) {
                        break;
                    }
                }
                
                // Populate table with calculation periods
                let grandTotal = 0;
                
                calculationPeriods.forEach((row, index) => {
                    // Calculate months between from and to date (fixed calculation)
                    const months = calculateMonthsBetweenDates(row.fromDate, row.toDate);
                    
                    // Calculate amounts with proper rounding
                    const amountDue = row.dueBasicPension + (row.dueBasicPension * row.drDue / 100);
                    const amountDrawn = basicPensionDrawn + (basicPensionDrawn * drawnDR / 100);
                    const difference = amountDue - amountDrawn;
                    const grossAmount = difference * months;
                    
                    // Round amounts
                    const roundedAmountDue = roundAmount(amountDue);
                    const roundedAmountDrawn = roundAmount(amountDrawn);
                    const roundedDifference = roundAmount(difference);
                    const roundedGrossAmount = roundAmount(grossAmount);
                    
                    grandTotal += roundedGrossAmount;
                    
                    tableRows.push({
                        fromDate: row.fromDate,
                        toDate: row.toDate,
                        dueBasicPension: row.dueBasicPension,
                        drDue: row.drDue,
                        amountDue: roundedAmountDue,
                        drawnBasicPension: basicPensionDrawn,
                        drawnDR: drawnDR,
                        amountDrawn: roundedAmountDrawn,
                        difference: roundedDifference,
                        months: months,
                        grossAmount: roundedGrossAmount,
                        revisionNo: row.revisionNo
                    });
                });
                
                // Render the table
                renderTable();
                
                // Add footer with grand total
                tableFooter.innerHTML = `
                    <tr class="total-row">
                        <td colspan="11" class="text-end"><strong>Grand Total:</strong></td>
                        <td><strong id="grandTotal">${Math.ceil(grandTotal)}</strong></td>
                    </tr>
                `;
                
                // Show the table and add row section
                document.getElementById('drTable').style.display = 'table';
                document.getElementById('addRowSection').style.display = 'block';
                document.getElementById('drTableStatus').textContent = `Calculation completed. ${calculationPeriods.length} period(s) calculated.`;
                document.getElementById('drTableStatus').className = 'alert alert-success';
                
            } catch (error) {
                console.error('Error calculating revision:', error);
                document.getElementById('drTableStatus').textContent = 'Error during calculation. Please check your inputs.';
                document.getElementById('drTableStatus').className = 'alert alert-danger';
            }
        }

        // Update grand total when values change
        function updateGrandTotal() {
            let grandTotal = 0;
            tableRows.forEach(row => {
                grandTotal += row.grossAmount;
            });
            document.getElementById('grandTotal').textContent = Math.ceil(grandTotal);
        }

        // Reset form to initial state
        function resetForm() {
            document.getElementById('treasury').value = '';
            document.getElementById('pensionerType').value = '';
            document.getElementById('pensionerCode').value = '';
            document.getElementById('pensionerName').value = '';
            document.getElementById('basicPensionDrawn').value = '';
            document.getElementById('drawnDR').value = '';
            document.getElementById('basicPensionDue').value = '';
            document.getElementById('revisionNoFrom').value = '';
            document.getElementById('revisionNoTo').value = '';
            initializeDates();
            clearDRTable();
            document.getElementById('drTableStatus').textContent = 'Please fill all details and click Calculate to generate the table.';
            document.getElementById('drTableStatus').className = 'alert alert-info';
            document.getElementById('drTable').style.display = 'none';
        }

        // Print calculation
        function printCalculation() {
            if (tableRows.length === 0) {
                alert('Please calculate first before printing.');
                return;
            }
            
            // Update print section with current data
            document.getElementById('printPensionerName').textContent = 
                document.getElementById('pensionerName').value.toUpperCase() || 'NOT PROVIDED';
            
            // Create pensioner code from all three parts
            const treasury = document.getElementById('treasury').value;
            const pensionerType = document.getElementById('pensionerType').value;
            const pensionerCode = document.getElementById('pensionerCode').value;
            const fullPensionerCode = `${treasury} - ${pensionerType} / ${pensionerCode}`;
            document.getElementById('printPensionerCode').textContent = fullPensionerCode || 'NOT PROVIDED';
            
            // Format dates for print in DD/MM/YYYY
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (fromDate) {
                const fromDateObj = new Date(fromDate);
                document.getElementById('printFromDate').textContent = formatDateToDDMMYYYY(fromDateObj);
            } else {
                document.getElementById('printFromDate').textContent = 'NOT PROVIDED';
            }
            
            if (toDate) {
                const toDateObj = new Date(toDate);
                document.getElementById('printToDate').textContent = formatDateToDDMMYYYY(toDateObj);
            } else {
                document.getElementById('printToDate').textContent = 'NOT PROVIDED';
            }
            
            // Populate print table
            const printTableBody = document.getElementById('printTableBody');
            printTableBody.innerHTML = '';
            
            let grandTotal = 0;
            
            tableRows.forEach((row, index) => {
                grandTotal += row.grossAmount;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.fromDate}</td>
                    <td>${row.toDate}</td>
                    <td>${row.dueBasicPension}</td>
                    <td>${row.drDue}%</td>
                    <td>${row.amountDue}</td>
                    <td>${row.drawnBasicPension}</td>
                    <td>${row.drawnDR}%</td>
                    <td>${row.amountDrawn}</td>
                    <td>${row.difference}</td>
                    <td>${row.months}</td>
                    <td>${row.grossAmount}</td>
                `;
                printTableBody.appendChild(tr);
            });
            
            // Add total row to print table
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="10" class="text-end"><strong>Grand Total:</strong></td>
                <td><strong>${Math.ceil(grandTotal)}</strong></td>
            `;
            printTableBody.appendChild(totalRow);
            
            // Show print section and trigger print
            document.getElementById('printSection').style.display = 'block';
            window.print();
            document.getElementById('printSection').style.display = 'none';
        }
    </script>
</body>
</html>
