<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Order Credit Booking Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            MIN-width: 100%;
            margin: 0 auto;
        }
        .upload-section, .summary-section, .table-section, .recalculate-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input[type="file"], input[type="number"] {
            padding: 6px;
        }
        .highlight {
            background-color: #ffffcc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Money Order Credit Booking Processor 01</h1>
        
        <div class="upload-section">
            <h2>Upload CSV File</h2>
            <input type="file" id="csvFile" accept=".csv,.txt">
            <button id="uploadBtn">Process CSV</button>
        </div>
        
        <div class="summary-section" id="summarySection" style="display: none;">
            <h2>Summary</h2>
            <p>Total Amount: <span id="totalAmount">0</span></p>
            <p>Number of Beneficiaries: <span id="beneficiaryCount">0</span></p>
            <button id="revalidateBtn">Merge and Download CSV</button>
        </div>
        
        <div class="table-section">
            <h2>Beneficiary Data</h2>
            <div id="tableContainer"></div>
        </div>
        <div class="recalculate-section" id="recalculateSection" style="display: none;">
        </div>
    </div>

    <script>
        document.getElementById('uploadBtn').addEventListener('click', processCSV);
        document.getElementById('revalidateBtn').addEventListener('click', mergeAndDownload);
        
        let csvData = [];
        let originalFileName = '';
        let headers = [];
        
        function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }
            
            originalFileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseCSV(content);
            };
            reader.readAsText(file);
        }
        
        function parseCSV(content) {
            const lines = content.split('\n');
            headers = lines[0].split(',');
            
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const obj = {};
                const currentLine = lines[i].split(',');
                
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentLine[j] || '';
                }
                
                csvData.push(obj);
            }
            
            displayData();
            updateSummary();
            
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('recalculateSection').style.display = 'block';
        }
        
        function displayData() {
            const tableContainer = document.getElementById('tableContainer');
            
            if (csvData.length === 0) {
                tableContainer.innerHTML = '<p>No data to display.</p>';
                return;
            }
            
            let tableHTML = '<table><thead><tr>';
            
            // Create headers
            for (const key in csvData[0]) {
                tableHTML += `<th>${key}</th>`;
            }
            tableHTML += '</tr></thead><tbody>';
            
            // Create rows
            csvData.forEach(row => {
                tableHTML += '<tr>';
                for (const key in row) {
                    tableHTML += `<td>${row[key]}</td>`;
                }
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
        }
        
        function updateSummary() {
            // Calculate total amount
            const totalAmount = csvData.reduce((sum, row) => sum + parseFloat(row.Amount || 0), 0);
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            
            // Count unique beneficiaries based on the last column value
            if (csvData.length > 0) {
                const lastColumnKey = headers[headers.length - 1];
                const uniqueValues = new Set();
                
                csvData.forEach(row => {
                    if (row[lastColumnKey]) {
                        uniqueValues.add(row[lastColumnKey]);
                    }
                });
                
                document.getElementById('beneficiaryCount').textContent = uniqueValues.size;
            } else {
                document.getElementById('beneficiaryCount').textContent = '0';
            }
        }
        
        function mergeAndDownload() {
            if (csvData.length === 0) {
                alert('No data to process');
                return;
            }

            // Group by beneficiary reference (using last column)
            const lastColumnKey = headers[headers.length - 1];
            const groupedData = {};
            
            csvData.forEach(row => {
                const ref = row[lastColumnKey];
                if (!groupedData[ref]) {
                    groupedData[ref] = [];
                }
                groupedData[ref].push(row);
            });
            
            // Process each beneficiary's rows to merge 5000 amounts
            const newCsvData = [];
            
            for (const ref in groupedData) {
                const beneficiaryRows = groupedData[ref];
                let i = 0;
                
                while (i < beneficiaryRows.length) {
                    const currentRow = beneficiaryRows[i];
                    
                    // Check if we can merge with next row (both 5000)
                    if (i + 1 < beneficiaryRows.length && 
                        parseFloat(currentRow.Amount) === 5000 && 
                        parseFloat(beneficiaryRows[i+1].Amount) === 5000) {
                        
                        // Create merged row with all columns preserved
                        const mergedRow = {};
                        // Copy all properties from current row
                        for (const key in currentRow) {
                            mergedRow[key] = currentRow[key];
                        }
                        // Update the amount
                        mergedRow.Amount = 10000;
                        
                        // For other columns, take the value from either row (prefer non-empty values)
                        for (const key in beneficiaryRows[i+1]) {
                            if (beneficiaryRows[i+1][key] && !mergedRow[key]) {
                                mergedRow[key] = beneficiaryRows[i+1][key];
                            }
                        }
                        
                        newCsvData.push(mergedRow);
                        i += 2; // Skip next row as we've merged it
                    } else {
                        // Can't merge, add as-is
                        newCsvData.push(currentRow);
                        i++;
                    }
                }
            }
            
            // Generate CSV content
            let csvContent = '';
            
            // Headers
            csvContent += headers.join(',') + '\n';
            
            // Rows - ensure all columns are included in the correct order
            newCsvData.forEach(row => {
                const rowValues = headers.map(header => {
                    // Handle missing values by providing empty string
                    return row[header] !== undefined ? row[header] : '';
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            // Download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', originalFileName + '_merged.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
