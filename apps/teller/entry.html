<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Assistant</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- SweetAlert for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Your existing styles here */
        .denomination-table th, .denomination-table td {
            text-align: center;
            vertical-align: middle;
        }
        .denomination-input {
            width: 80px;
            text-align: center;
        }
        .section-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .bundle-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .total-amount {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0d6efd;
        }
        .currency-column {
            font-weight: bold;
        }
        .remaining-limit {
            color: #dc3545;
            font-weight: bold;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            background-color: #f8f9fa;
            border-bottom-color: #f8f9fa;
        }
        .tab-content {
            background-color: #f8f9fa;
            padding: 20px;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            border-radius: 0 0 5px 5px;
        }
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="container py-4">
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    </div>

    <div class="card">
        <div class="card-header bg-white">
            <h4 class="mb-0">Cashier Assistant</h4>
        </div>
        
        <div class="card-body p-0">
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="cashierTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="receipt-tab" data-bs-toggle="tab" data-bs-target="#receipt" type="button" role="tab">Receipt</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab">Payment</button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="cashierTabsContent">
                <!-- Receipt Tab -->
                <div class="tab-pane fade show active" id="receipt" role="tabpanel" aria-labelledby="receipt-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mt-3">Basic Details</h5>
                            <div class="mb-3">
                                <label for="treasury" class="form-label">Treasury</label>
                                <input type="text" class="form-control" id="treasury" placeholder="Enter Treasury Name">
                            </div>
                            <div class="mb-3">
                                <label for="pen" class="form-label">Permanent Employee Number (PEN)</label>
                                <input type="text" class="form-control" id="pen" placeholder="Enter PEN">
                            </div>
                            <div class="mb-3">
                                <label for="dob" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="dob">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="mt-3">Amount Borrowed</h5>
                            <table class="table table-bordered denomination-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Currency</th>
                                        <th>Count</th>
                                        <th>Bundles</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="borrowedDenominations">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4">
                                            <button class="btn btn-primary" onclick="updateBorrowedAmount()">Update Borrowed Amount</button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Tab -->
                <div class="tab-pane fade" id="payment" role="tabpanel" aria-labelledby="payment-tab">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="paymentAmount" class="form-label">Payment Amount</label>
                            <input type="number" class="form-control" id="paymentAmount" placeholder="Enter amount">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-success" onclick="calculateDenominations()">Calculate Denominations</button>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="total-amount">Total: ₹0</div>
                        </div>
                    </div>
                    
                    <table class="table table-bordered denomination-table">
                        <thead class="table-light">
                            <tr>
                                <th>Currency</th>
                                <th>Denomination</th>
                                <th>Count</th>
                                <th>Bundles</th>
                                <th>Subtotal</th>
                                <th>Remaining Limit</th>
                            </tr>
                        </thead>
                        <tbody id="paymentDenominations">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-primary" onclick="savePaymentDetails()">Save Payment Details</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration - REPLACE WITH YOUR ACTUAL WEB APP URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxQJFIQlYmSZpRal2XxkpzHCA0v4PHK97WEzgPb7uCW6kGUiWGdoXVN-J-IR9G2k2lc/exec";
        
        // Currency denominations
        const DENOMINATIONS = [
            { value: 2000, label: "₹2000" },
            { value: 500, label: "₹500" },
            { value: 200, label: "₹200" },
            { value: 100, label: "₹100" },
            { value: 50, label: "₹50" },
            { value: 20, label: "₹20" },
            { value: 10, label: "₹10" },
            { value: 5, label: "₹5" },
            { value: 2, label: "₹2" },
            { value: 1, label: "₹1" }
        ];
        
        // State management
        let borrowedAmounts = {};
        let paymentAmounts = {};
        let remainingLimits = {};
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadBasicDetails();
            initializeDenominationTables();
            
            // Load borrowed amounts when receipt tab is shown
            document.getElementById('receipt-tab').addEventListener('shown.bs.tab', loadBorrowedAmounts);
        });
        
        // Initialize all tables
        function initializeDenominationTables() {
            initializeBorrowedDenominations();
            initializePaymentDenominations();
        }
        
        // Load basic details from localStorage
        function loadBasicDetails() {
            const treasury = localStorage.getItem('cashierAssistant_treasury');
            const pen = localStorage.getItem('cashierAssistant_pen');
            const dob = localStorage.getItem('cashierAssistant_dob');
            
            if (treasury) document.getElementById('treasury').value = treasury;
            if (pen) document.getElementById('pen').value = pen;
            if (dob) document.getElementById('dob').value = dob;
        }
        
        // Save basic details to localStorage
        function saveBasicDetails() {
            const treasury = document.getElementById('treasury').value;
            const pen = document.getElementById('pen').value;
            const dob = document.getElementById('dob').value;
            
            localStorage.setItem('cashierAssistant_treasury', treasury);
            localStorage.setItem('cashierAssistant_pen', pen);
            localStorage.setItem('cashierAssistant_dob', dob);
            
            return { treasury, pen, dob };
        }
        
        // Initialize borrowed denominations table
        function initializeBorrowedDenominations() {
            const tableBody = document.getElementById('borrowedDenominations');
            tableBody.innerHTML = '';
            
            DENOMINATIONS.forEach(denom => {
                borrowedAmounts[denom.value] = 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="currency-column">${denom.label}</td>
                    <td><input type="number" class="form-control denomination-input" id="borrowed_${denom.value}" value="0" min="0"></td>
                    <td class="bundle-info">${Math.floor(borrowedAmounts[denom.value] / 100)}</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="addBundle(${denom.value})">+100</button></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Initialize payment denominations table
        function initializePaymentDenominations() {
            const tableBody = document.getElementById('paymentDenominations');
            tableBody.innerHTML = '';
            
            DENOMINATIONS.forEach(denom => {
                paymentAmounts[denom.value] = 0;
                remainingLimits[denom.value] = 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="currency-column">${denom.label}</td>
                    <td>${denom.value}</td>
                    <td><input type="number" class="form-control denomination-input" id="payment_${denom.value}" value="0" min="0" onchange="updatePaymentAmount(${denom.value})"></td>
                    <td class="bundle-info">${Math.floor(paymentAmounts[denom.value] / 100)}</td>
                    <td>₹${paymentAmounts[denom.value] * denom.value}</td>
                    <td class="remaining-limit">${remainingLimits[denom.value]}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Add a bundle (100 units) to borrowed amount
        function addBundle(denomination) {
            const input = document.getElementById(`borrowed_${denomination}`);
            input.value = parseInt(input.value) + 100;
            updateBorrowedAmount();
        }
        
        // Load borrowed amounts from Google Sheets
        async function loadBorrowedAmounts() {
            const { treasury, pen } = saveBasicDetails();
            
            if (!treasury || !pen) {
                console.log("Treasury and PEN required to load borrowed amounts");
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: "getBorrowedAmounts",
                        treasury: treasury,
                        pen: pen
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the borrowed amounts
                    DENOMINATIONS.forEach((denom, index) => {
                        borrowedAmounts[denom.value] = result.denominations[index] || 0;
                        const input = document.getElementById(`borrowed_${denom.value}`);
                        if (input) input.value = borrowedAmounts[denom.value];
                        
                        // Update bundle info
                        const row = input.closest('tr');
                        if (row) {
                            row.querySelector('.bundle-info').textContent = Math.floor(borrowedAmounts[denom.value] / 100);
                        }
                    });
                    
                    // Update remaining limits
                    updateRemainingLimits();
                } else {
                    throw new Error(result.error || "Failed to load borrowed amounts");
                }
            } catch (error) {
                console.error("Error loading borrowed amounts:", error);
                Swal.fire({
                    title: 'Error!',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                showLoading(false);
            }
        }
        
        // Update borrowed amounts from input fields
        async function updateBorrowedAmount() {
            const { treasury, pen, dob } = saveBasicDetails();
            
            if (!treasury || !pen) {
                alert("Please enter Treasury and PEN details");
                return;
            }
            
            let totalBorrowed = 0;
            const denominationCounts = [];
            
            DENOMINATIONS.forEach(denom => {
                const input = document.getElementById(`borrowed_${denom.value}`);
                const count = parseInt(input.value) || 0;
                borrowedAmounts[denom.value] = count;
                denominationCounts.push(count);
                
                // Update bundle info
                const row = input.closest('tr');
                row.querySelector('.bundle-info').textContent = Math.floor(count / 100);
                
                totalBorrowed += count * denom.value;
            });
            
            showLoading(true);
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: "saveReceipt",
                        treasury: treasury,
                        pen: pen,
                        dob: dob,
                        denominations: denominationCounts
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        title: 'Success!',
                        text: result.message,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    
                    // Update remaining limits
                    updateRemainingLimits();
                } else {
                    throw new Error(result.error || "Failed to save borrowed amounts");
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error!',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                showLoading(false);
            }
        }
        
        // Calculate denominations for payment amount
        function calculateDenominations() {
            const amountInput = document.getElementById('paymentAmount');
            let amount = parseInt(amountInput.value) || 0;
            
            if (amount <= 0) {
                alert("Please enter a valid amount");
                return;
            }
            
            // Reset payment amounts
            DENOMINATIONS.forEach(denom => {
                paymentAmounts[denom.value] = 0;
            });
            
            // Calculate denominations (greedy algorithm)
            DENOMINATIONS.forEach(denom => {
                if (amount >= denom.value) {
                    const maxPossible = Math.min(
                        Math.floor(amount / denom.value),
                        remainingLimits[denom.value]
                    );
                    
                    if (maxPossible > 0) {
                        paymentAmounts[denom.value] = maxPossible;
                        amount -= maxPossible * denom.value;
                    }
                }
            });
            
            // If we couldn't make exact change with available denominations
            if (amount > 0) {
                alert(`Warning: Could not provide exact change. Remaining amount: ₹${amount}`);
            }
            
            // Update the payment table
            updatePaymentTable();
        }
        
        // Update payment table with current values
        function updatePaymentTable() {
            let totalAmount = 0;
            
            DENOMINATIONS.forEach(denom => {
                const input = document.getElementById(`payment_${denom.value}`);
                input.value = paymentAmounts[denom.value];
                
                const row = input.closest('tr');
                row.querySelector('.bundle-info').textContent = Math.floor(paymentAmounts[denom.value] / 100);
                row.querySelector('td:nth-child(5)').textContent = `₹${paymentAmounts[denom.value] * denom.value}`;
                
                totalAmount += paymentAmounts[denom.value] * denom.value;
            });
            
            document.querySelector('.total-amount').textContent = `Total: ₹${totalAmount}`;
        }
        
        // Update payment amount when user manually changes denomination counts
        function updatePaymentAmount(denomination) {
            const input = document.getElementById(`payment_${denomination}`);
            const count = parseInt(input.value) || 0;
            
            // Check if count exceeds remaining limit
            if (count > remainingLimits[denomination]) {
                alert(`Cannot exceed remaining limit of ${remainingLimits[denomination]} for ₹${denomination} notes`);
                input.value = paymentAmounts[denomination];
                return;
            }
            
            paymentAmounts[denomination] = count;
            
            // Recalculate total
            let totalAmount = 0;
            DENOMINATIONS.forEach(denom => {
                totalAmount += paymentAmounts[denom.value] * denom.value;
            });
            
            document.querySelector('.total-amount').textContent = `Total: ₹${totalAmount}`;
            
            // Update bundle info
            const row = input.closest('tr');
            row.querySelector('.bundle-info').textContent = Math.floor(count / 100);
            row.querySelector('td:nth-child(5)').textContent = `₹${count * denomination}`;
        }
        
        // Update remaining limits based on borrowed amounts
        function updateRemainingLimits() {
            DENOMINATIONS.forEach(denom => {
                remainingLimits[denom.value] = borrowedAmounts[denom.value];
                
                const row = document.getElementById(`payment_${denom.value}`).closest('tr');
                row.querySelector('.remaining-limit').textContent = remainingLimits[denom.value];
            });
        }
        
        // Save payment details to Google Sheets
        async function savePaymentDetails() {
            const { treasury, pen } = saveBasicDetails();
            
            if (!treasury || !pen) {
                alert("Please enter Treasury and PEN details");
                return;
            }
            
            let totalAmount = 0;
            const denominationCounts = [];
            
            DENOMINATIONS.forEach(denom => {
                const count = paymentAmounts[denom.value] || 0;
                denominationCounts.push(count);
                totalAmount += count * denom.value;
            });
            
            if (totalAmount <= 0) {
                alert("Please enter a valid payment amount");
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: "savePayment",
                        treasury: treasury,
                        pen: pen,
                        date: new Date().toISOString().split('T')[0],
                        denominations: denominationCounts
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        title: 'Success!',
                        text: result.message,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    
                    // Update remaining limits (subtract used denominations)
                    DENOMINATIONS.forEach(denom => {
                        borrowedAmounts[denom.value] -= paymentAmounts[denom.value];
                        remainingLimits[denom.value] = borrowedAmounts[denom.value];
                    });
                    
                    updateRemainingLimits();
                    updatePaymentTable();
                    document.getElementById('paymentAmount').value = '';
                } else {
                    throw new Error(result.error || "Failed to save payment");
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error!',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                showLoading(false);
            }
        }
        
        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
