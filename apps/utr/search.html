<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTR Lookup Tool</title>
    <style>
   * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .description {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .input-section {
            margin-bottom: 25px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-with-button {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #lookup-btn {
            background-color: #3498db;
            color: white;
        }
        
        #lookup-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        
        #lookup-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        #clear-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        #clear-btn:hover {
            background-color: #c0392b;
        }
        
        .format-info {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .format-info h4 {
            color: #1565c0;
            margin-bottom: 8px;
        }
        
        .result-section {
            margin-top: 25px;
            display: none;
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3498db;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .result-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-found {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-not-found {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .result-details {
            margin-top: 15px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .detail-label {
            font-weight: 600;
            color: #6c757d;
            width: 150px;
        }
        
        .detail-value {
            color: #2c3e50;
            flex: 1;
            word-break: break-all;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .status.progress {
            background-color: #cce7ff;
            color: #004085;
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .instructions {
            background-color: #fff9e6;
            border-left: 4px solid #f1c40f;
            padding: 15px;
            margin-top: 25px;
            border-radius: 0 6px 6px 0;
            position: relative;
        }
        
        .instructions.hidden {
            display: none;
        }
        
        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .instructions h3 {
            color: #d35400;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #d35400;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close-btn:hover {
            background-color: rgba(211, 84, 0, 0.1);
        }
        
        .instructions ol {
            padding-left: 20px;
            color: #7f8c8d;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .api-info {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 6px 6px 0;
            font-size: 14px;
        }
        
        .api-info h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .history-section {
            margin-top: 25px;
            display: none;
        }
        
        .history-section.show {
            display: block;
        }
        
        .history-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .extracted-utr {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .show-instructions-btn {
            background-color: #fff;
            color: #3498db;
            margin-top: 15px;
            display: none;
        }
        
        .show-instructions-btn:hover {
            background-color: #fff;
        }
		.last-updated {
    text-align: center;
    color: #7f8c8d;
    margin-bottom: 30px;
    line-height: 1.5;
    font-size: 14px;
    font-style: italic;
}
    </style>
</head>
<body>
    <div class="container">
      <h1>UTR New Format Search</h1>
<div class="last-updated" id="last-updated">Last updated: Loading...</div>
<hr>
      
		   <div class="instructions" id="instructions">
            <div class="instructions-header">
                <h3>How to Use </h3>
                <button class="close-btn" id="close-instructions">Ã—</button>
            </div>
            <ol>
                <li>Enter UTR with RBISH format and click Search</li>
                <li>Search New UTR with BiMS &gt; UTR Search</li>
            </ol>
        </div> <button class="show-instructions-btn" id="show-instructions" style="display: none;">Show Instructions</button>
        <br>
        <div class="input-section">
            <div class="input-group">
                <label for="utr-input">Enter UTR Number</label>
                <div class="input-with-button">
                    <input type="text" id="utr-input" placeholder="e.g., RBISH0123456789 or /XUTR/RBISH0123456789" maxlength="50">
                    <button id="lookup-btn">Search</button>
					<button id="clear-btn">Clear</button>
                </div>
            </div>
            
              <div class="status" id="status"></div>
            
            <div class="extracted-utr" id="extracted-utr" style="display: none;">
                <strong>Extracted UTR for search:</strong> <span id="extracted-value"></span>
            </div>
        </div>
        
        <div class="result-section" id="result-section">
            <div class="result-card">
                <div class="result-header">
                    <span class="result-label">Search Result</span>
                    <span class="result-status" id="result-status">Found</span>
                </div>
                <div class="result-details">
                    <div class="detail-row">
                        <span class="detail-label">Search UTR:</span>
                        <span class="detail-value" id="search-utr">-</span>
                    </div>
                    <div class="detail-row"style="display:none;">
                        <span class="detail-label">Extracted UTR:</span>
                        <span class="detail-value" id="extracted-utr-display">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">New UTR:</span>
                        <span class="detail-value" id="new-utr"style="color:red;font-weight:bold">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date:</span>
                        <span class="detail-value" id="result-date">-</span>
                    </div>
				
                    <div class="detail-row" style="display:none;">
                        <span class="detail-label">Full Value:</span>
                        <span class="detail-value" id="full-cell-value">-</span>
                    </div>
                    <div class="detail-row"style="display:none;">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="result-message">-</span>
                    </div>
					
                </div>
            </div>
        </div>
        
    
        
        <div class="history-section" id="history-section">
            <div class="history-title">Recent Searches:</div>
            <div class="history-list" id="history-list">
                <!-- History items will be added here -->
            </div>
        </div>
        
      
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API Configuration
            const API_KEY = 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4';
            const SPREADSHEET_ID = '10W5sxg5tyoE7N4h2khLd5t5tCfR6-YYyUl9OJuS41ZI';
            const SHEET_NAME = 'DB';
            const RANGE = 'A:C'; // Columns: Date, Old UTR, New UTR
            
            // DOM Elements
            const utrInput = document.getElementById('utr-input');
            const lookupBtn = document.getElementById('lookup-btn');
            const clearBtn = document.getElementById('clear-btn');
            const resultSection = document.getElementById('result-section');
            const resultStatus = document.getElementById('result-status');
            const searchUtr = document.getElementById('search-utr');
            const extractedUtrDisplay = document.getElementById('extracted-utr-display');
            const newUtr = document.getElementById('new-utr');
            const resultDate = document.getElementById('result-date');
            const fullCellValue = document.getElementById('full-cell-value');
            const resultMessage = document.getElementById('result-message');
            const statusDiv = document.getElementById('status');
            const historySection = document.getElementById('history-section');
            const historyList = document.getElementById('history-list');
            const extractedUtrDiv = document.getElementById('extracted-utr');
            const extractedValue = document.getElementById('extracted-value');
            const instructionsDiv = document.getElementById('instructions');
            const closeInstructionsBtn = document.getElementById('close-instructions');
            const showInstructionsBtn = document.getElementById('show-instructions');
            
            let searchHistory = JSON.parse(localStorage.getItem('utrSearchHistory')) || [];
            let instructionsHidden = localStorage.getItem('instructionsHidden') === 'true';
            
            // Initialize instructions display
            updateInstructionsDisplay();
            
            // Event Listeners
            lookupBtn.addEventListener('click', performLookup);
            clearBtn.addEventListener('click', clearSearch);
            closeInstructionsBtn.addEventListener('click', hideInstructions);
            showInstructionsBtn.addEventListener('click', showInstructions);
            
            utrInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performLookup();
                }
            });
            
            utrInput.addEventListener('input', function() {
                // Auto-format to uppercase
                this.value = this.value.toUpperCase();
                
                // Extract and show UTR preview
                const extracted = extractUTR(this.value);
                if (extracted && extracted !== this.value) {
                    extractedValue.textContent = extracted;
                    extractedUtrDiv.style.display = 'block';
                } else {
                    extractedUtrDiv.style.display = 'none';
                }
                
                // Enable/disable lookup button based on input
                lookupBtn.disabled = !this.value.trim();
            });
            // Add this function to fetch last updated date
async function fetchLastUpdatedDate() {
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!E1?key=${API_KEY}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.values && data.values.length > 0 && data.values[0].length > 0) {
            const lastUpdatedElement = document.getElementById('last-updated');
            lastUpdatedElement.textContent = `Last updated: ${data.values[0][0]}`;
        }
    } catch (error) {
        console.error('Error fetching last updated date:', error);
        const lastUpdatedElement = document.getElementById('last-updated');
        lastUpdatedElement.textContent = 'Last updated: Date unavailable';
    }
}
            // Extract UTR from various formats
            function extractUTR(input) {
                if (!input) return '';
                
                // Remove any spaces
                input = input.trim();
                
                // Case 1: Already in RBISH0 format
                if (input.startsWith('RBISH0')) {
                    return input;
                }
                
                // Case 2: Format like /XUTR/RBISH0123456789
                if (input.includes('/XUTR/')) {
                    const parts = input.split('/XUTR/');
                    if (parts.length > 1 && parts[1].startsWith('RBISH0')) {
                        return parts[1];
                    }
                }
                
                // Case 3: Try to extract RBISH0 followed by numbers
                const utrMatch = input.match(/RBISH0\d+/);
                if (utrMatch) {
                    return utrMatch[0];
                }
                
                // Case 4: Return original input (let API handle validation)
                return input;
            }
            
            // Perform UTR lookup
            async function performLookup() {
                const inputValue = utrInput.value.trim();
                
                if (!inputValue) {
                    showStatus('Please enter a UTR value', 'error');
                    return;
                }
                
                const extractedUTR = extractUTR(inputValue);
                
                // Validate extracted UTR format
                if (!extractedUTR.startsWith('RBISH0')) {
                    showStatus('Invalid UTR format. Should start with RBISH0', 'error');
                    return;
                }
                
                showStatus('Searching for UTR...', 'progress');
                lookupBtn.disabled = true;
                
                try {
                    const result = await searchUTRInSheet(extractedUTR);
                    displayResult(inputValue, extractedUTR, result);
                    addToHistory(inputValue, extractedUTR, result);
                    
                } catch (error) {
                    console.error('Lookup error:', error);
                    showStatus('Error searching for UTR: ' + error.message, 'error');
                    lookupBtn.disabled = false;
                }
            }
            
            // Search UTR in Google Sheet
            async function searchUTRInSheet(utrValue) {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE}?key=${API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    return { found: false, message: 'No data found ' };
                }
                
                // Skip header row and search for UTR in column B (index 1)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    if (row.length >= 2) {
                        const cellValue = row[1] || '';
                        
                        // Check if cell contains the UTR (in /XUTR/RBISH0 format)
                        if (cellValue.includes(utrValue)) {
                            return {
                                found: true,
                                date: row[0] || 'N/A',
                                newUTR: row[2] || 'N/A',
                                fullCellValue: cellValue,
                                message: 'UTR found '
                            };
                        }
                    }
                }
                
                return { found: false, message: 'UTR not found in database' };
            }
            
            // Display search result
            function displayResult(inputValue, extractedUTR, result) {
                searchUtr.textContent = inputValue;
                extractedUtrDisplay.textContent = extractedUTR;
                
                if (result.found) {
                    resultStatus.textContent = 'Found';
                    resultStatus.className = 'result-status status-found';
                    newUtr.textContent = result.newUTR;
                    resultDate.textContent = formatDate(result.date);
                    fullCellValue.textContent = result.fullCellValue || 'N/A';
                    resultMessage.textContent = result.message;
                    resultMessage.style.color = '#155724';
                } else {
                    resultStatus.textContent = 'Not Found';
                    resultStatus.className = 'result-status status-not-found';
                    newUtr.textContent = 'N/A';
                    resultDate.textContent = 'N/A';
                    fullCellValue.textContent = 'N/A';
                    resultMessage.textContent = result.message;
                    resultMessage.style.color = '#721c24';
                }
                
                resultSection.classList.add('show');
                showStatus(result.message, result.found ? 'success' : 'error');
                lookupBtn.disabled = false;
            }
            
            // Add search to history
            function addToHistory(inputValue, extractedUTR, result) {
                const historyItem = {
                    input: inputValue,
                    extracted: extractedUTR,
                    found: result.found,
                    newUTR: result.newUTR || 'N/A',
                    timestamp: new Date().toLocaleString()
                };
                
                // Add to beginning of history
                searchHistory.unshift(historyItem);
                
                // Keep only last 10 items
                if (searchHistory.length > 10) {
                    searchHistory = searchHistory.slice(0, 10);
                }
                
                // Save to localStorage
                localStorage.setItem('utrSearchHistory', JSON.stringify(searchHistory));
                
                // Update display
                updateHistoryDisplay();
            }
            
            // Update history display
            function updateHistoryDisplay() {
                historyList.innerHTML = '';
                
                if (searchHistory.length === 0) {
                    historySection.classList.remove('show');
                    return;
                }
                
                searchHistory.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    historyItem.innerHTML = `
                        <div>
                            <strong>${item.input}</strong>
                            <div style="font-size: 12px; color: #666;">Extracted: ${item.extracted}</div>
                            <div style="font-size: 11px; color: #999;">${item.timestamp}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${item.found ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                ${item.found ? 'Found' : 'Not Found'}
                            </div>
                            <div style="font-size: 12px; color: #666;">${item.newUTR}</div>
                        </div>
                    `;
                    
                    historyList.appendChild(historyItem);
                });
                
                historySection.classList.add('show');
            }
            
            // Clear search
            function clearSearch() {
                utrInput.value = '';
                resultSection.classList.remove('show');
                extractedUtrDiv.style.display = 'none';
                statusDiv.className = 'status';
                lookupBtn.disabled = true;
                utrInput.focus();
            }
            
            // Format date for display
            function formatDate(dateValue) {
                if (!dateValue) return 'N/A';
                
                try {
                    // Try to parse as date
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString();
                    }
                    return dateValue;
                } catch (error) {
                    return dateValue;
                }
            }
            
            // Show status message
            function showStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = 'status';
                
                if (type === 'success') {
                    statusDiv.classList.add('success');
                } else if (type === 'error') {
                    statusDiv.classList.add('error');
                } else if (type === 'progress') {
                    statusDiv.innerHTML = `<span class="loading"></span>${message}`;
                    statusDiv.classList.add('progress');
                }
            }
            
            // Hide instructions
            function hideInstructions() {
                instructionsHidden = true;
                localStorage.setItem('instructionsHidden', 'true');
                updateInstructionsDisplay();
            }
            
            // Show instructions
            function showInstructions() {
                instructionsHidden = false;
                localStorage.setItem('instructionsHidden', 'false');
                updateInstructionsDisplay();
            }
            
            // Update instructions display
            function updateInstructionsDisplay() {
                if (instructionsHidden) {
                    instructionsDiv.classList.add('hidden');
                    showInstructionsBtn.style.display = 'block';
                } else {
                    instructionsDiv.classList.remove('hidden');
                    showInstructionsBtn.style.display = 'none';
                }
            }
            fetchLastUpdatedDate();
            // Auto-focus on input
            utrInput.focus();
        });
    </script>
</body>
</html>
