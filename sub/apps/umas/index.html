<!DOCTYPE html>
<html>
<head>
    <title>UMAS Request</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #d7e2ff6e;
            padding: 20px;
        }
        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin: 10px 40px 30px 40px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        select {
            width: 100%;
            height: 30px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 15px;
        }
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .col {
            flex: 1;
        }
        .form-control, .form-select, .select2-selection {
            height: calc(1.5em + 0.75rem + 2px) !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 0.875rem !important;
        }
        .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        .btn-group {
            width: 100%;
        }
        .btn-group .btn {
            width: 50%;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 20px;
        }
        .select2-container--default .select2-selection--single {
            height: 42px;
            padding: 5px;
            border: 1px solid #ddd;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 35px;
        }
        .section-header {
            background-color: #f0f7ff;
            padding: 10px 15px;
            margin: 25px 0 15px 0;
            border-left: 4px solid #4285f4;
            font-weight: bold;
            color: #2c3e50;
        }
        .hidden-section {
            display: none;
        }
        #treasury.select2-selection--single {
            background-color: #f8f9fa;
            pointer-events: none;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h3>UMAS Data Change Form</h3>
        
        <form id="treasuryForm">
            <div class="form-group">
                <label for="optionFor">Option For*</label>
                <select id="optionFor" name="optionFor" class="form-control select2-dropdown" required>
                    <option value="">Select Option</option>
                    <option value="User Activation">User Activation</option>
                    <option value="Charge Arrangement" selected>Charge Arrangement</option>
                    <option value="Role Change">Role Change</option>
                    <option value="Designation Change">Designation Change</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="treasury">Treasury*</label>
                <select id="treasury" name="treasury" class="form-control select2-dropdown" required></select>
            </div>
            
            <div class="section-header">From Employee Details</div>
            <p style="color: #ff0000;"> * in Charge Arrangements give '0' as PEN and "Vacant" as Name ; if user is inactive/not listed or in leave for more than 2 days. </p>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="fromPEN">From PEN</label>
                        <input type="text" class="form-control" id="fromPEN" name="fromPEN" placeholder="Employee PEN ">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fromName">From Name*</label>
                        <input type="text" class="form-control" id="fromName" name="fromName" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="fromDesignation">From Designation</label>
                        <select id="fromDesignation" name="fromDesignation" class="form-control select2-dropdown"></select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fromRole">From Role</label>
                        <select id="fromRole" name="fromRole" class="form-control select2-dropdown"></select>
                    </div>
                </div>
            </div>
            
            <div class="section-header to-employee-section">To Employee Details</div>
            
            <div class="row to-employee-section">
                <div class="col">
                    <div class="form-group">
                        <label for="toPEN">To PEN</label>
                        <input type="text" class="form-control" id="toPEN" name="toPEN">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toName">To Name*</label>
                        <input type="text" class="form-control" id="toName" name="toName" required>
                    </div>
                </div>
            </div>
            
            <div class="row to-employee-section">
                <div class="col">
                    <div class="form-group">
                        <label for="toDesignation">To Designation</label>
                        <select id="toDesignation" name="toDesignation" class="form-control select2-dropdown"></select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toRole">To Role</label>
                        <select id="toRole" name="toRole" class="form-control select2-dropdown"></select>
                    </div>
                </div>
            </div>
            
            <div class="section-header date-range-section">Date Range</div>
           
            <div class="row date-range-section">
                 <p style="color: #ff0000;"> * Maximum period for Working Arrangement is 90 Days</p>
                <div class="col">
                    <div class="form-group">
                        <label for="fromDate">From Date*</label>
                        <input type="text" id="fromDate" name="fromDate" class="form-control flatpickr-input" placeholder="DD/MM/YYYY" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toDate">To Date*</label>
                        <input type="text" id="toDate" name="toDate" class="form-control flatpickr-input" placeholder="DD/MM/YYYY" required>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="reset" class="btn btn-secondary">Reset</button>
                <a href="#" class="btn btn-light" onclick="openPopup()">PDF</a>    
            </div>
        </form>
        <div id="requestIdLabel" style="font-weight: bold; color: red; text-align: center; margin-top: 15px;"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            mainSpreadsheetId: '1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM',
            employeeSpreadsheetId: '1pOhA7N0HufnqmwD7KBCW8xhDKCh-gxZ-tOeZ2-4qq7k',
            apiKey: 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4'
        };

        // Utility Functions
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatTimestamp(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function generateRequestId() {
            const now = new Date();
            return [
                now.getFullYear().toString().slice(-2),
                (now.getMonth() + 1).toString().padStart(2, '0'),
                now.getDate().toString().padStart(2, '0'),
                now.getHours().toString().padStart(2, '0'),
                now.getMinutes().toString().padStart(2, '0'),
                now.getSeconds().toString().padStart(2, '0')
            ].join('');
        }

        // Data Fetching Functions
        async function fetchSheetData(spreadsheetId, range, sheetName) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}!${range}?key=${CONFIG.apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values || [];
        }

        async function loadDropdownData() {
            try {
                const [designations, roles, optionsFor] = await Promise.all([
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'B2:B', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'C2:C', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'D2:D', 'settings')
                ]);
                
                populateDropdown('fromDesignation', designations.flat());
                populateDropdown('toDesignation', designations.flat());
                populateDropdown('fromRole', roles.flat());
                populateDropdown('toRole', roles.flat());
                populateDropdown('optionFor', optionsFor.flat());
                
                $('#optionFor').val('Charge Arrangement').trigger('change');
                return true;
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                Swal.fire('Error', 'Failed to load dropdown data', 'error');
                return false;
            }
        }

        function populateDropdown(id, items) {
            const $dropdown = $(`#${id}`);
            $dropdown.empty().append('<option value=""></option>');
            
            if (items && items.length) {
                const uniqueItems = [...new Set(items)];
                uniqueItems.forEach(item => {
                    if (item) $dropdown.append($('<option>').val(item).text(item));
                });
            }
            $dropdown.trigger('change');
        }

        // Form Handling Functions
        function setupPENAutofill() {
            $('#fromPEN').on('change', async function() {
                const pen = $(this).val();
                if (pen) {
                    await autofillEmployeeDetails(pen, 'from');
                    if ($('#optionFor').val() === "User Activation") {
                        $('#toPEN').val(pen);
                        $('#toName').val($('#fromName').val());
                        $('#toDesignation').val($('#fromDesignation').val()).trigger('change');
                        $('#toRole').val($('#fromRole').val()).trigger('change');
                    }
                }
            });
            
            $('#toPEN').on('change', async function() {
                if ($('#optionFor').val() !== "User Activation") {
                    const pen = $(this).val();
                    if (pen) {
                        await autofillEmployeeDetails(pen, 'to');
                    }
                }
            });
        }

        async function autofillEmployeeDetails(pen, prefix) {
            try {
                const employeeData = await fetchSheetData(CONFIG.employeeSpreadsheetId, 'A2:E', 'employee');
                const employee = employeeData.find(row => row[2] === pen);
                
                if (employee) {
                    $(`#${prefix}Name`).val(employee[1]);
                    $(`#${prefix}Designation`).val(employee[3]).trigger('change');
                    $(`#${prefix}Role`).val(employee[4]).trigger('change');
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Employee Not Found',
                        text: `No employee found with PEN: ${pen}`,
                        timer: 2000
                    });
                }
            } catch (error) {
                console.error('Error fetching employee data:', error);
                Swal.fire('Error', 'Failed to fetch employee details', 'error');
            }
        }

        function handleOptionForChange() {
            const optionFor = $('#optionFor').val();
            const today = new Date();
            const todayFormatted = formatDate(today);
            
            if (optionFor === "User Activation") {
                fromDatePicker.setDate(today, true);
                toDatePicker.setDate(today, true);
                $('#toPEN').val($('#fromPEN').val());
                $('#toName').val($('#fromName').val());
                $('#toDesignation').val($('#fromDesignation').val()).trigger('change');
                $('#toRole').val($('#fromRole').val()).trigger('change');
                $('.to-employee-section, .date-range-section').addClass('hidden-section');
            } else {
                $('.to-employee-section, .date-range-section').removeClass('hidden-section');
                $('#toPEN').val('');
                $('#toName').val('');
                $('#toDesignation').val(null).trigger('change');
                $('#toRole').val(null).trigger('change');
                fromDatePicker.clear();
                toDatePicker.clear();
            }
        }

        // Initialize Application
        function initApplication() {
            // Get treasury name from URL or session storage
            const urlParams = new URLSearchParams(window.location.search);
            let treasuryName = urlParams.get('treasury');
            
            if (!treasuryName) {
                try {
                    treasuryName = sessionStorage.getItem('treasuryName');
                } catch (e) {
                    console.log("Couldn't access parent session storage");
                }
            }
            
            // Set treasury field if name exists
            if (treasuryName) {
                const treasurySelect = document.getElementById('treasury');
                treasurySelect.innerHTML = '';
                const option = document.createElement('option');
                option.value = treasuryName;
                option.textContent = treasuryName;
                option.selected = true;
                treasurySelect.appendChild(option);
            }
            
            // Initialize date pickers
            const fromDatePicker = flatpickr("#fromDate", {
                dateFormat: "d/m/Y",
                allowInput: true
            });
            
            const toDatePicker = flatpickr("#toDate", {
                dateFormat: "d/m/Y",
                allowInput: true
            });
            
            // Initialize Select2 dropdowns
            $('.select2-dropdown').select2({
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select an option';
                }
            });
            
            // Make treasury field read-only
            $('#treasury').next('.select2-container').find('.select2-selection').css({
                'background-color': '#f8f9fa',
                'pointer-events': 'none',
                'cursor': 'not-allowed'
            });
            
            // Load dropdown data
            loadDropdownData();
            
            // Setup event handlers
            setupPENAutofill();
            $('#optionFor').on('change', handleOptionForChange);
            handleOptionForChange();
            
            $('button[type="reset"]').on('click', function() {
                setTimeout(function() {
                    handleOptionForChange();
                    $('.select2-dropdown').not('#treasury').val(null).trigger('change');
                    if (treasuryName) {
                        $('#treasury').val(treasuryName).trigger('change');
                    }
                    document.getElementById('requestIdLabel').textContent = '';
                }, 0);
            });
            
            // Form submission
            document.getElementById('treasuryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
                
                const formData = new FormData(this);
                const formObject = {};
                formData.forEach((value, key) => {
                    formObject[key] = value;
                });
                
                formObject.requestId = generateRequestId();
                formObject.timestamp = formatTimestamp(new Date());
                formObject.status = "Pending";
                
                if (formObject.optionFor === "User Activation") {
                    formObject.toPEN = formObject.fromPEN;
                    formObject.toName = formObject.fromName;
                    formObject.toDesignation = formObject.fromDesignation;
                    formObject.toRole = formObject.fromRole;
                }
                
                const url = new URL('https://script.google.com/macros/s/AKfycbwXvCX8W0iMUxR5mvLXW5TbaoRvb0gdOYpJZrPFkVzdgtAByIH6YQNXyqwtF4QtJzS63A/exec');
                Object.keys(formObject).forEach(key => {
                    url.searchParams.append(key, formObject[key]);
                });
                
                fetch(url, {
                    method: 'GET',
                    redirect: 'follow'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(text => {
                    try {
                        const data = text ? JSON.parse(text) : {};
                        if (data.result === 'success') {
                            document.getElementById('requestIdLabel').textContent = `Request ID: ${formObject.requestId}`;
                            Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: 'Form submitted successfully!',
                                footer: `Request ID: ${formObject.requestId}<br>Timestamp: ${formObject.timestamp}`
                            });
                            this.reset();
                            $('.select2-dropdown').not('#treasury').val(null).trigger('change');
                            if (treasuryName) {
                                $('#treasury').val(treasuryName).trigger('change');
                            }
                            handleOptionForChange();
                        } else {
                            throw new Error(data.message || 'Failed to submit form');
                        }
                    } catch {
                        document.getElementById('requestIdLabel').textContent = `Request ID: ${formObject.requestId}`;
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Form submitted successfully!',
                            footer: `Request ID: ${formObject.requestId}<br>Timestamp: ${formObject.timestamp}`
                        });
                        this.reset();
                        $('.select2-dropdown').not('#treasury').val(null).trigger('change');
                        if (treasuryName) {
                            $('#treasury').val(treasuryName).trigger('change');
                        }
                        handleOptionForChange();
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message,
                    });
                    console.error('Error:', error);
                })
                .finally(() => {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                });
            });
        }

        // Popup function
        function openPopup() {
            const url = "https://script.google.com/macros/s/AKfycbzywjcUltvzofjDglUovicJfcWWN1oe0jFZCRwhCgA/dev";
            const windowFeatures = "width=600,height=400,resizable=yes,scrollbars=yes";
            const popup = window.open(url, "PopupWindow", windowFeatures);

            if (!popup || popup.closed || typeof popup.closed === "undefined") {
                window.location.href = url;
            }
        }

        // Start the application when DOM is loaded
        $(document).ready(initApplication);
    </script>
</body>
</html>
