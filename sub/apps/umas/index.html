<!DOCTYPE html>
<html>
<head>
    <title>UMAS Request</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #d7e2ff6e;
            padding: 20px;
        }
        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin: 10px 40px 30px 40px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
     
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"],
        select {
            width: 100%;
            height: 30px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 15px;
        }
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .col {
            flex: 1;
        }
        .form-control, .form-select, .select2-selection {
            height: calc(1.5em + 0.75rem + 2px) !important;
            padding: 0.375rem 0.75rem !important;
            font-size: 0.875rem !important;
        }
        .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        .btn-group {
            width: 100%;
        }
        .btn-group .btn {
            width: 50%;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 20px;
        }
        .select2-container--default .select2-selection--single {
            height: 42px;
            padding: 5px;
            border: 1px solid #ddd;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 35px;
        }
        .section-header {
            background-color: #f0f7ff;
            padding: 10px 15px;
            margin: 25px 0 15px 0;
            border-left: 4px solid #4285f4;
            font-weight: bold;
            color: #2c3e50;
        }
        .hidden-section {
            display: none;
        }
        
        /* Add this new style for read-only treasury field */
        #treasury.select2-selection--single {
            background-color: #f8f9fa;
            pointer-events: none;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h3>UMAS Data Change Form</h3>
        
        <form id="treasuryForm">
                 <div class="form-group">
                <label for="optionFor">Option For*</label>
                <select id="optionFor" name="optionFor" class="form-control select2-dropdown" required>
                    <option value="">Select Option</option>
                    <option value="User Activation">User Activation</option>
                    <option value="Charge Arrangement" selected>Charge Arrangement</option>
                    <option value="Role Change">Role Change</option>
                    <option value="Designation Change">Designation Change</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="treasury">Treasury*</label>
                <select id="treasury" name="treasury" class="form-control select2-dropdown" required></select>
            </div>
            
            <div class="section-header">From Employee Details</div>
            <p style="color: #ff0000;"> * in Charge Arrangements give '0' as PEN and "Vacant" as Name ; if user is inactive/not listed or in leave for more than 2 days. </p>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="fromPEN">From PEN</label>
                        <input type="text" class="form-control" id="fromPEN" name="fromPEN" placeholder="Employee PEN ">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fromName">From Name*</label>
                        <input type="text" class="form-control" id="fromName" name="fromName" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="fromDesignation">From Designation</label>
                        <select id="fromDesignation" name="fromDesignation" class="form-control select2-dropdown"></select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fromRole">From Role</label>
                        <select id="fromRole" name="fromRole" class="form-control select2-dropdown"></select>
                    </div>
                </div>
            </div>
            
            <div class="section-header to-employee-section">To Employee Details</div>
            
            <div class="row to-employee-section">
                <div class="col">
                    <div class="form-group">
                        <label for="toPEN">To PEN</label>
                        <input type="text" class="form-control" id="toPEN" name="toPEN">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toName">To Name*</label>
                        <input type="text" class="form-control" id="toName" name="toName" required>
                    </div>
                </div>
            </div>
            
            <div class="row to-employee-section">
                <div class="col">
                    <div class="form-group">
                        <label for="toDesignation">To Designation</label>
                        <select id="toDesignation" name="toDesignation" class="form-control select2-dropdown"></select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toRole">To Role</label>
                        <select id="toRole" name="toRole" class="form-control select2-dropdown"></select>
                    </div>
                </div>
            </div>
            
            <div class="section-header date-range-section">Date Range</div>
           
            <div class="row date-range-section">
                 <p style="color: #ff0000;"> * Maximum period for Working Arrangement is 90 Days</p>
                <div class="col">
                    <div class="form-group">
                        <label for="fromDate">From Date*</label>
                        <input type="text" id="fromDate" name="fromDate" class="form-control flatpickr-input" placeholder="DD/MM/YYYY" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="toDate">To Date*</label>
                        <input type="text" id="toDate" name="toDate" class="form-control flatpickr-input" placeholder="DD/MM/YYYY" required>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="reset" class="btn btn-secondary">Reset</button>
              
     <a href="#" class="btn btn-light" onclick="openPopup()">PDF</a>    
            </div>
        </form>
        <div id="requestIdLabel" style="font-weight: bold; color: red; text-align: center; margin-top: 15px;"></div>
    </div>
       <script>
    function openPopup() {
    const url = "https://script.google.com/macros/s/AKfycbzywjcUltvzofjDglUovicJfcWWN1oe0jFZCRwhCgA/dev";
    const windowFeatures = "width=600,height=400,resizable=yes,scrollbars=yes";
    const popup = window.open(url, "PopupWindow", windowFeatures);

    if (!popup || popup.closed || typeof popup.closed === "undefined") {
        // Pop-up blocked, open in the same tab
        window.location.href = url;
    }
}
</script>
    <script>
        // Configuration
        const CONFIG = {
            mainSpreadsheetId: '1laWjV6MFOfbb7Xg2kzBVz99Ho3S74PN81BM0UlqRcmM',
            employeeSpreadsheetId: '1pOhA7N0HufnqmwD7KBCW8xhDKCh-gxZ-tOeZ2-4qq7k',
            apiKey: 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4'
        };

        // Initialize date pickers with DD/MM/YYYY format
        const fromDatePicker = flatpickr("#fromDate", {
            dateFormat: "d/m/Y",
            allowInput: true
        });
        
        const toDatePicker = flatpickr("#toDate", {
            dateFormat: "d/m/Y",
            allowInput: true
        });

        // Initialize Select2 dropdowns
        $(document).ready(function() {
            // First, try to get treasury name from URL or session storage
            const urlParams = new URLSearchParams(window.location.search);
            let treasuryName = urlParams.get('treasury');
            
            if (!treasuryName) {
                try {
                    treasuryName = sessionStorage.getItem('treasuryName');
                } catch (e) {
                    console.log("Couldn't access parent session storage");
                }
            }
            
            // If we have a treasury name, populate the select dropdown
            if (treasuryName) {
                const treasurySelect = document.getElementById('treasury');
                treasurySelect.innerHTML = ''; // Clear any existing options
                const option = document.createElement('option');
                option.value = treasuryName;
                option.textContent = treasuryName;
                option.selected = true;
                treasurySelect.appendChild(option);
            }
            
            // Initialize other Select2 dropdowns
            $('.select2-dropdown').select2({
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder') || 'Select an option';
                }
            });
            
            // Make treasury field read-only
            $('#treasury').next('.select2-container').find('.select2-selection').css({
                'background-color': '#f8f9fa',
                'pointer-events': 'none',
                'cursor': 'not-allowed'
            });
            
            // Load other dropdown data when page loads
            loadDropdownData();
            
            // Setup PEN input event listeners
            setupPENAutofill();
            
            // Handle Option For change
            $('#optionFor').on('change', handleOptionForChange);
            
            // Set initial state
            handleOptionForChange();
            
            // Reset form handler
            $('button[type="reset"]').on('click', function() {
                setTimeout(function() {
                    handleOptionForChange();
                    $('.select2-dropdown').val(null).trigger('change');
                    // Keep treasury value on reset
                    if (treasuryName) {
                        $('#treasury').val(treasuryName).trigger('change');
                    }
                    document.getElementById('requestIdLabel').textContent = ''; // Clear request ID on reset
                }, 0);
            });
        });

        async function loadDropdownData() {
            try {
                // Load data from Settings sheet - no longer loading treasury codes
                const [designations, roles, optionsFor] = await Promise.all([
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'B2:B', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'C2:C', 'settings'),
                    fetchSheetData(CONFIG.mainSpreadsheetId, 'D2:D', 'settings')
                ]);
                
                // Populate dropdowns
                populateDropdown('fromDesignation', designations.flat());
                populateDropdown('toDesignation', designations.flat());
                populateDropdown('fromRole', roles.flat());
                populateDropdown('toRole', roles.flat());
                populateDropdown('optionFor', optionsFor.flat());
                
                // Set default value for Option For
                $('#optionFor').val('Charge Arrangement').trigger('change');
                
                return true;
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                Swal.fire('Error', 'Failed to load dropdown data', 'error');
                return false;
            }
        }

        // Rest of your existing JavaScript functions remain the same...
        // [Keep all other existing functions unchanged]
        
    </script>
</body>
</html>
